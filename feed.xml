<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://benwzj.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://benwzj.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-12-11T12:34:45+00:00</updated><id>https://benwzj.github.io/feed.xml</id><title type="html">BEN WEN</title><subtitle>A website to show the world of Ben Wen </subtitle><entry><title type="html">Python Build-in Type</title><link href="https://benwzj.github.io/blog/2024/python-type/" rel="alternate" type="text/html" title="Python Build-in Type"/><published>2024-12-11T00:00:00+00:00</published><updated>2024-12-11T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/python-type</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/python-type/"><![CDATA[<p>JavaScript have primitive type concept. But Python donâ€™t.</p> <p>Data type in python:</p> <ul> <li>Numeric,</li> <li>Sequence,</li> <li>Set,</li> <li>Mapping.</li> </ul> <p>(String, list, tuple, range and byte are sequence. )</p> <p>â€” Numeric</p> <p>â€” int integer is a whole number, positive or negative, without decimals, of unlimited length.</p> <p>â€” float Float, or â€œfloating point numberâ€ is a number, positive or negative, containing one or more decimals.</p> <p>â€” Complex Complex numbers are written with a â€œjâ€ as the imaginary part</p> <p>â€” Questions</p> <p>â€” What is float(â€˜infâ€™)</p> <ul> <li>It acts as an unbounded upper value for comparison.</li> <li>This is useful for finding lowest values for something.</li> </ul> <p>â€“ for example, calculating path route costs when traversing trees.</p> <blockquote> <blockquote> <blockquote> <p>lowest_path_cost = float(â€˜infâ€™)</p> <h1 id="pretend-that-these-were-calculated-using-some-worthwhile-algorithm">pretend that these were calculated using some worthwhile algorithm</h1> <p>path_costs = [1, 100, 2000000000000, 50] for path in path_costs: â€¦ if path &lt; lowest_path_cost: â€¦ lowest_path_cost = path â€¦ lowest_path_cost</p> </blockquote> </blockquote> </blockquote> <ul> <li>if you didnâ€™t have float(â€˜Infâ€™) available to you, what value would you use for the initial lowest_path_cost? Would 9999999 be enough â€“ float(â€˜Infâ€™) removes this guesswork.</li> </ul> <p>â€” Binary Sequence</p> <p>The core built-in types for manipulating binary data are bytes and bytearray. They are supported by memoryview which uses the buffer protocol to access the memory of other binary objects without needing to make a copy.</p> <p>â€” Bytes Objects Firstly, the syntax for bytes literals is largely the same as that for string literals, except that a b prefix is added: Single quotes: bâ€™still allows embedded â€œdoubleâ€ quotesâ€™</p> <p>Only ASCII characters are permitted in bytes literals (regardless of the declared source code encoding). Any binary values over 127 must be entered into bytes literals using the appropriate escape sequence.</p> <p>bytes object share all behavior with bytearray except for itâ€™s immutability.</p> <p>â€“ In addition to the literal forms, bytes objects can be created in a number of other ways:</p> <ul> <li>A zero-filled bytes object of a specified length: bytes(10)</li> <li>From an iterable of integers: bytes(range(20))</li> <li>Copying existing binary data via the buffer protocol: bytes(obj)</li> </ul> <p>â€“ classmethod fromhex(string) This bytes class method returns a bytes object, decoding the given string object. The string must contain two hexadecimal digits per byte, with ASCII whitespace being ignored.</p> <blockquote> <blockquote> <blockquote> <p>bytes.fromhex(â€˜2Ef0 F1f2 â€˜) bâ€™.\xf0\xf1\xf2â€™</p> </blockquote> </blockquote> </blockquote> <p>â€“ hex() Return a string object containing two hexadecimal digits for each byte in the instance.</p> <blockquote> <blockquote> <blockquote> <p>bâ€™\xf0\xf1\xf2â€™.hex() â€˜f0f1f2â€™</p> </blockquote> </blockquote> </blockquote> <p>â€” Bytearray Objects</p> <p>There is no dedicated literal syntax for bytearray objects, instead they are always created by calling the constructor:</p> <ul> <li>Creating an empty instance: bytearray()</li> <li>Creating a zero-filled instance with a given length: bytearray(10)</li> <li>From an iterable of integers: bytearray(range(20))</li> <li>Copying existing binary data via the buffer protocol: bytearray(bâ€™Hi!â€™)</li> </ul> <p>â€“ support classmethod fromhex(string) and hex() as well. akin to bytes.</p> <p>â€” String</p> <p>Textual data in Python is handled with str objects, or call strings. Strings are immutable sequences of Unicode code points.</p> <ul> <li>Like JavaScript, strings in Python are arrays of bytes representing unicode characters.</li> <li>Square brackets can be used to access elements of the string.</li> <li>You can loop through a string.</li> <li>Using len() to get length of a string.</li> <li>Support keyword in, not in.</li> <li>Python doesnâ€™t have character type, a single character is simply a string with a length of 1.</li> <li>You can assign a multiline string to a variable by using three quotes.</li> <li>Python has a set of built-in methods that you can use on strings.</li> </ul> <p>â€” Basic String common operation</p> <p>â€“ String slice syntax string slice is a convenient way to operate string.</p> <p>b = â€œHello, World!â€ b[2] #â€lâ€ b[2:5] #â€lloâ€ b[::-1] #reverse a string: â€œ!dlroW ,olleHâ€</p> <p>â€“ split string a = â€œHello, World!â€ print(a.split(â€œ,â€)) # [â€˜Helloâ€™, â€˜ World!â€™]</p> <p>â€“ join string opposite of split(), joins the elements in the given list together. a = [â€˜Helloâ€™, â€˜ World!â€™] print(â€œ,â€.join(a)) # â€œHello, World!â€</p> <p>â€“ replace a = â€œHello, World!â€ print(a.replace(â€œHâ€, â€œJâ€)) # â€œJello, World!â€</p> <p>â€“ find() and rfind() find() return the index of the first location. rfine() return the index of last one.</p> <p>â€“ s.lower(), s.upper() returns the lowercase or uppercase version of the string</p> <p>â€“ translate() The translate() method returns a string where some specified characters are replaced with the character described in a dictionary, or in a mapping table.</p> <ul> <li>Use the str.maketrans() method to create a mapping table.</li> </ul> <p>â€” str Object</p> <p>class str(object=â€™â€™) class str(object=bâ€™â€™, encoding=â€™utf-8â€™, errors=â€™strictâ€™)</p> <p>Return a string version of object. If object is not provided, returns the empty string. Otherwise, the behavior of str() depends on whether encoding or errors is given.</p> <p>print(â€œ20 days are â€œ + str(20<em>24</em>60*60) +â€ secondsâ€)</p> <p>â€” String module</p> <p>string module is a built-in module and we have to import it before using any of its constants and classes. Because str class, String module have been old. and you should not use.</p> <p>â€” String format</p> <p>There are several way to format, manipulate string:</p> <ul> <li>printf-style, template, str.format() have been old style way.</li> <li>f-string is the latest way and recommend use.</li> </ul> <p>â€“ printf-style String Formatting (old sytle)</p> <p>String objects have one unique built-in operation: the % operator (modulo). The effect is similar to using the sprintf() in the C language.</p> <ul> <li>Example: print(â€˜%(language)s has %(number)03d quote types.â€™ % {â€˜languageâ€™: â€œPythonâ€, â€œnumberâ€: 2}) // Python has 002 quote types.</li> </ul> <p>def dec2hexstring(dec): decimal = int(dec) hexa = â€˜%#Xâ€™ % decimal return hexa</p> <ul> <li>But recommend to use the newer formatted string literals, the str.format() interface, or template strings. f-String is latest way to format string!</li> </ul> <p>â€“ str.format(*args, **kwargs)</p> <p>Perform a string formatting operation. (Format string means create string, make string.) The string on which this method is called can contain literal text or replacement fields delimited by braces {}.</p> <ul> <li>Introduced in Python 2.6.</li> <li>str.format(), when deal with multiple arguments, and long strings. it will looks verbose.</li> </ul> <blockquote> <blockquote> <blockquote> <p>â€œThe sum of 1 + 2 is {0}â€.format(1+2) â€˜The sum of 1 + 2 is 3â€™</p> </blockquote> </blockquote> </blockquote> <blockquote> <blockquote> <blockquote> <p>â€˜{2}, {1}, {0}â€™.format(â€˜aâ€™, â€˜bâ€™, â€˜câ€™) â€˜c, b, aâ€™</p> </blockquote> </blockquote> </blockquote> <ul> <li>Format String Syntax: replacement_field ::= â€œ{â€œ [field_name] [â€!â€ conversion] [â€:â€ format_spec] â€œ}â€</li> </ul> <p>â€¢ field_name can be 0, 1, 2â€¦ which is positional of the parameters. or be nothing, which still positional. or be key name of the dic which is the parameter. or be attribute of object which is the parameter.</p> <p>â€¢ conversion have three options: !s, !r, !a</p> <blockquote> <blockquote> <blockquote> <p>â€œrepr() shows quotes: {!r}; str() doesnâ€™t: {!s}â€.format(â€˜test1â€™, â€˜test2â€™) â€œrepr() shows quotes: â€˜test1â€™; str() doesnâ€™t: test2â€</p> </blockquote> </blockquote> </blockquote> <p>â€¢ format_spec is a Mini-Languag! Start from â€˜:â€™. For example display in Hexadecimal, or octal, binary. It can do more, specify the type, fill, align, width, precision :</p> <blockquote> <blockquote> <blockquote> <p>for align, text in zip(â€˜&lt;^&gt;â€™, [â€˜leftâ€™, â€˜centerâ€™, â€˜rightâ€™]): â€¦ â€˜{0:{fill}{align}16}â€™.format(text, fill=align, align=align) â€¦ â€˜leftÂ«Â«Â«Â«Â«Â«â€™ â€˜^^^^^center^^^^^â€™ â€˜Â»Â»Â»Â»Â»&gt;rightâ€™ Using the comma as a thousands separator: â€˜â€˜.format(1234567890) â€˜1,234,567,890â€™</p> </blockquote> </blockquote> </blockquote> <ul> <li>Nesting arguments: for align, text in zip(â€˜&lt;^&gt;â€™, [â€˜leftâ€™, â€˜centerâ€™, â€˜rightâ€™]): print(â€˜{align}30}â€™.format(text, fill=align, align=align))</li> </ul> <p>â€“ Template strings</p> <p>Template strings is very simple string formatting tool which focus on substitutions.</p> <ul> <li> <p>A primary use case for template strings is for internationalization (i18n) since in that context, the simpler syntax and functionality makes it easier to translate than other built-in string formatting facilities in Python.</p> </li> <li> <p>The string module provides a Template class that implements these rules.</p> </li> <li> <p>Main methods is substitute(), and safe_substitute()</p> </li> </ul> <p>from string import Template s = Template(â€˜$who likes $whatâ€™) s1 = s.substitute(who=â€™timâ€™, what=â€™kung paoâ€™) print(s1) #â€™tim likes kung paoâ€™</p> <p>â€“ formatted string literal / f-Strings (Python 3.6+ new syntax)</p> <ul> <li>(f-String are similar to JavaScriptâ€™s Template Literal)</li> <li>A formatted string literal or f-string is a string literal that is prefixed with â€˜fâ€™ or â€˜Fâ€™.</li> <li>These strings may contain replacement fields, which are expressions delimited by curly braces {}.</li> <li>While other string literals always have a constant value, formatted strings are really expressions evaluated at run time.</li> <li>f-strings are a great new way to format strings. Not only are they more readable, more concise, and less prone to error than other ways of formatting, but they are also faster!</li> <li>format syntax is similar to str.format()</li> </ul> <blockquote> <blockquote> <blockquote> <p>name = â€œFredâ€ fâ€He said his name is {name!r}.â€ â€œHe said his name is â€˜Fredâ€™.â€ fâ€He said his name is {name}.â€ â€œHe said his name is Fred.â€</p> </blockquote> </blockquote> </blockquote> <blockquote> <blockquote> <blockquote> <p>number = 1024 fâ€{number:#0x}â€ # using integer format specifier â€˜0x400â€™</p> </blockquote> </blockquote> </blockquote> <ul> <li> <p>Support triple quote mark. So it is easy to support Multiline f-Strings</p> </li> <li> <p>f-string support function</p> <blockquote> <blockquote> <blockquote> <p>def to_lowercase(input): â€¦ return input.lower()</p> </blockquote> </blockquote> </blockquote> </li> </ul> <blockquote> <blockquote> <blockquote> <p>name = â€œEric Idleâ€ fâ€{to_lowercase(name)} is funny.â€ â€˜eric idle is funny.â€™</p> </blockquote> </blockquote> </blockquote> <p>â€” Unicode Support</p> <p>Great presentation about Unicode: https://nedbatchelder.com/text/unipain.html</p> <p>â€“ Overview</p> <ul> <li> <p>Strings can either be represented in bytes or unicode code points. Byte strings and unicode strings each have a method to convert it to the other type of string. unicode .encode() â†’ bytes bytes .decode() â†’ unicode</p> </li> <li> <p>In Python 2, a string is by default a binary string and you need to use uâ€™â€™ to mark a string as a Unicode string. If you try to perform a string operation that combines a unicode string with a byte string, Python 2 try to be helpful, it will implicitly decode the byte string to produce a second unicode string, then complete the operation. But the conversion from int to float canâ€™t fail, while byte string to unicode string can.</p> </li> <li> <p>In Python 3, a string by default is a Unicode string (You donâ€™t need to know HOW Python deal with it), and you need to use bâ€™â€™ to explicitly mark a string as a binary string. bytes and str are different types. In Python3, they are not converted to each other implicitly. You need to handle both types by yourself.</p> </li> <li> <p>The default encoding for Python source code is UTF-8, so you can simply include a Unicode character (or use u escape) in a string literal: print(â€œFichier non trouvÃ©â€)</p> <blockquote> <blockquote> <blockquote> <p>â€œ\u0394â€ # Using a 16-bit hex value â€˜\u0394â€™ Python 3 also supports using Unicode characters in identifiers. (JavaScript support as well)</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€“ Unicode Sandwich theory</p> <ul> <li> <p>A good practice is to decode your bytes in UTF-8 (or an encoder that was used to create those bytes) as soon as they are loaded from a file. Run your processing on unicode code points through your Python code, and then write back into bytes into a file using UTF-8 encoder in the end.</p> </li> <li> <p>Python3 handles Unicode strings with unicode code points. You donâ€™t need to know HOW. This is the job of Python 3. You can just take it as a black box. Python3 make sure you can use all the methods of str type. Just remember the Sandwich mode! What you need to handle is decode as soon as possible, and encode at the end.</p> </li> </ul> <p>â€“ 5 fact of life about unicode string in Python</p> <p>1, everything in a computer is bytes. Files on disk are a series of bytes, and network connections only transmit bytes.</p> <p>2, The world needs more than 256 symbols</p> <p>3, Bytes and Unicode, Need to keep them straight, Need to deal with both.</p> <ul> <li>You canâ€™t pretend that everything is bytes, or everything is unicode. You need to use each for their purpose, and explicitly convert between them as needed.</li> <li>So Python 2â€™s pain is deferred: you think your program is correct, and find out later that it fails with exotic characters.</li> <li>With Python 3, your code fails immediately, so even if you are only handling ASCII, you have to explicitly deal with the difference between bytes and unicode.</li> </ul> <p>4, Encoding is out-of-band. You cannot infer the encoding of bytes. You must be told, or you have to guess.</p> <p>5, Data is dirty. Sometimes you are told wrong.</p> <p>â€“ 3 Pro tips</p> <ul> <li>Unicode Sandwich</li> <li>Know what you have! Bytes or Unicode? If bytes, what encoding?</li> <li>Test Unicode</li> </ul> <p>â€“ Reading files</p> <p>In Python 3, the two modes produce different results. When you open a file in text mode, either with â€œrâ€, or by defaulting the mode entirely, the data read from the file is implicitly decoded into Unicode, and you get str objects. If you open a file in binary mode, by supplying â€œrbâ€ as the mode, then the data read from the file is bytes, with no processing done on them.</p> <blockquote> <blockquote> <blockquote> <p>open(â€œhello.txtâ€, â€œrâ€).read() â€˜Hello, world!\nâ€™ open(â€œhello.txtâ€, â€œrbâ€).read() bâ€™Hello, world!\nâ€™</p> </blockquote> </blockquote> </blockquote> <ul> <li>To get the file read properly, you should specify an encoding to use. The open() function now has an optional encoding parameter. <blockquote> <blockquote> <blockquote> <p>open(â€œhi_utf8.txtâ€, â€œrâ€, encoding=â€utf-8â€).read() â€˜Hi \u2119\u01b4\u2602\u210c\xf8\u1f24â€™ open(â€œhi_utf8.txtâ€, â€œrâ€).read() # wrong encoding â€˜Hi \xe2\u201e\u2122\xc6\xb4\xe2\u02dc\u201a\xe2\u201e\u0152\xc3\xb8\xe1\xbc\xa4â€™</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€“ Internal representations for Unicode strings</p> <p>Even the default encoding for Python source code is UTF-8. But for Unicode strings, Python uses three kinds of internal representations : 1 byte per char (Latin-1 encoding) 2 bytes per char (UCS-2 encoding) 4 bytes per char (UCS-4 encoding)</p> <p>If all characters in a string can fit in ASCII range, then they are encoded using 1-byte Latin-1 encoding. But if there are any char which need two bytes, then Python will encoding all to UCS-2. same</p> <ul> <li>This is because each character in a string must take up an equivalent number of bytes! otherwise, operations such as indexing, slicing would be inaccurate. s0 = â€˜aâ€™ print(sys.getsizeof(s0+â€™bâ€™) - sys.getsizeof(s0)) <blockquote> <p>1 s1 = â€˜ä½ â€™ print(sys.getsizeof(s1+â€™ä½ â€™) - sys.getsizeof(s1)) 2 print(sys.getsizeof(s1+â€™ä½ aâ€™) - sys.getsizeof(s1)) 4 s1 = â€˜ğŸâ€™ print(sys.getsizeof(s1+â€™ğŸä½ â€™) - sys.getsizeof(s1)) 8</p> </blockquote> </li> <li>Within CPython, unicode characters are stored as PyUnicodeObject instances. We can view the format of a PyUnicodeObject by looking at the source code:</li> </ul> <p>â€“ build-in function chr(), ord()</p> <p>Convert between One-character Unicode strings and code point value. These tow functions do nothing about encoding.</p> <ul> <li>chr() takes code point value(integers) and returns a Unicode string of length 1 that contains the corresponding code point.</li> <li>ord() takes a one-character Unicode string and returns the code point value (integers). <h1 id="u0041--a">â€˜\u0041â€™ == â€˜Aâ€™</h1> <blockquote> <blockquote> <blockquote> <p>chr(65) â€˜\u0041â€™ ord(â€˜\u0041â€™) 65</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€“ Unicode Literals in Python Source Code In Python source code, specific Unicode code points can be written using the \u escape sequence, which is followed by four hex digits giving the code point. The \U escape sequence is similar, but expects eight hex digits, not four:</p> <blockquote> <blockquote> <blockquote> <p>s = â€œa\xac\u1234\u20ac\U00008000â€ [ord(c) for c in s] [97, 172, 4660, 8364, 32768]</p> </blockquote> </blockquote> </blockquote> <p>â€“ bytes.decode() and str.encode()</p> <ul> <li>bytes.decode() can create a string. This method takes an encoding argument, such as UTF-8, and optionally an errors argument. (\xNN escape sequence means that NN is Hexadecimal value) <blockquote> <blockquote> <blockquote> <p>bâ€™\x41â€™.decode(â€œutf-8â€) A bâ€™\x41\x00â€™.decode(â€œutf-16â€) A</p> </blockquote> </blockquote> </blockquote> </li> <li>str.encode(), returns a bytes representation of the Unicode string, encoded in the requested encoding. (opposite method of bytes.decode()) <blockquote> <blockquote> <blockquote> <p>u = chr(65) + â€˜abcdâ€™ + chr(66) u.encode(â€˜utf-8â€™) bâ€™AabcdBâ€™ u.encode(â€˜utf-16â€™) bâ€™\xff\xfeA\x00a\x00b\x00c\x00d\x00B\x00â€™</p> </blockquote> </blockquote> </blockquote> </li> <li>Unicode code point for emoji ğŸ– is U+1F590</li> </ul> <p>print((â€œä½ å¥½ğŸ–â€).encode(â€œunicode_escapeâ€)) bâ€™\u4f60\u597d\U0001f590â€™</p> <p>print((â€œä½ å¥½ğŸ–â€).encode()) bâ€™\xe4\xbd\xa0\xe5\xa5\xbd\xf0\x9f\x96\x90â€™</p> <p>â€“ codecs module The low-level routines for registering and accessing the available encodings are found in the codecs module. Implementing new encodings also requires understanding the codecs module.</p> <p>â€“ Uncode in JavaScript</p> <ul> <li>While a JavaScript source file can have any kind of encoding, JavaScript will then convert it internally to UTF-16 before executing it.</li> <li>JavaScript strings are all UTF-16 sequences, as the ECMAScript standard says: When a String contains actual textual data, each element is considered to be a single UTF-16 code unit.</li> <li>UTF-16 encoding need to use with surrogate pairs. For the code points which bigger than U+FFFF.</li> <li>Example (use u escape): console.log(â€˜the heart eyes emoji is \ud83d\ude0dâ€™) <blockquote> <p>the heart eyes emoji is ğŸ˜</p> </blockquote> </li> </ul> <p>â€“ Tips for Writing Unicode-aware Programs</p> <ul> <li>Software should only work with Unicode strings internally,</li> <li>decoding the input data as soon as possible and,</li> <li>encoding the output only at the end.</li> </ul> <p>â€” String interning</p> <p>String interning is a method of storing only one copy of each distinct string value in memory, which must be immutable.</p> <ul> <li> <p>String interning concept is akin to shared object concept! shared object is more popular in immutable object.</p> </li> <li> <p>String Interning can Saving Memory, Fast Comparisons, Fast Dictionary Lookups.</p> </li> </ul> <p>â€“ Implicit String interning.</p> <ul> <li>Implicitly intern string depends on several factors: â€¢ All empty strings and strings of length 1 are interned. â€¢ Up until version 3.7, Python used peephole optimization, and all strings longer than 20 characters were not interned. However, now it uses the AST optimizer, and (most) strings up to 4096 characters are interned. â€¢ Names of functions, class, variables, arguments, etc. are implicitly interned. â€¢ The keys of dictionaries used to hold module, class, or instance attributes are interned. â€¢ Strings are interned only at compile-time, this means that they will not be interned if their value canâ€™t be computed at compile-time.</li> </ul> <p>s1 = â€˜iambenwenâ€™ s2 = â€˜iambenwenâ€™ print(s1 is s2)</p> <blockquote> <p>true</p> </blockquote> <blockquote> <blockquote> <blockquote> <p>â€œstrinâ€+â€gâ€ is â€œstringâ€ True</p> </blockquote> </blockquote> </blockquote> <ul> <li>Python wonâ€™t intern all the string. <blockquote> <blockquote> <blockquote> <p>c = â€˜Yâ€™<em>4097 d = â€˜Yâ€™</em>4097 c is d false</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>s1 = â€œwenâ€.join([â€œbâ€, â€œeâ€, â€œnâ€]) s2 = â€œwenâ€.join([â€œbâ€, â€œeâ€, â€œnâ€]) print(s1 is s2)</p> <blockquote> <p>false</p> </blockquote> <blockquote> <blockquote> <blockquote> <p>s1 = â€œstrinâ€ s2 = â€œstringâ€ s1+â€gâ€ is s2 False</p> </blockquote> </blockquote> </blockquote> <ul> <li>Donâ€™t Rely on the Implicit String Interning Because the rules of the implicit string interning could be different according to different compiler, interpreter. For example, up until the version of Python 3.7, the peephole optimization is used for string interning and all strings longer than 20 characters will not be interned. However, the algorithm was changed to the AST optimizer then, and the length is equal to 4096 rather than 20.</li> </ul> <p>â€“ Explicit interning:</p> <blockquote> <blockquote> <blockquote> <p>import sys c = sys.intern(â€˜Yâ€™<em>4097) d = sys.intern(â€˜Yâ€™</em>4097) c is d True</p> </blockquote> </blockquote> </blockquote> <p>In practice, we should use the == operator to compare strings. If we need to speed up the comparison, intern the strings explicitly.</p> <p>â€“ Disadvantages of String Interning</p> <ul> <li>Memory Cost.</li> <li>Time Cost: The call to intern() function is expensive as it has to manage the interned table.</li> <li>not friendly for Multi-threaded Environments .</li> </ul> <p>â€“ The following comparison returns True because of shared objects. CPython loads the Latin-1 range of characters unicode decimals 0 to 255, inclusive, as shared objects every time Python is initialized. Any calls to values in this range are referred to those pre-existing objects. s3 = â€˜levinâ€™ s4 = â€˜eliseâ€™ print(s3[1] is s4[0])</p> <blockquote> <p>true</p> </blockquote> <p>â€” String Questions</p> <p>â€“ If using u escape sequence follow by code point can display Unicode string. why need encoding? s = â€œ\u0041\u1234\u20ac\u8000\U0002070Eâ€</p> <p>print([ord(c) for c in s]) # get unicodeâ€™s integer value:</p> <blockquote> <p>[65, 4660, 8364, 32768, 132878]</p> </blockquote> <p>print([chr(ord(i)) for i in s]) # get one-character string:</p> <blockquote> <p>[â€˜Aâ€™, â€˜áˆ´â€™, â€˜â‚¬â€™, â€˜è€€â€™, â€˜ğ œâ€™]</p> </blockquote> <p>print(s.encode(â€˜utf-8â€™).hex()) # get actually bytes of utf-8 encoding:</p> <blockquote> <p>41e188b4e282ace88080f0a09c8e</p> </blockquote> <p>print(s.encode(â€˜utf-16â€™).hex()) # get utf-16</p> <blockquote> <p>fffe41003412ac20008041d80edf</p> </blockquote> <p>print(s.encode(â€˜utf-32â€™).hex()) # get utf-32</p> <blockquote> <p>fffe00004100000034120000ac200000008000000e070200</p> </blockquote> <p>(The Unicode character U+FEFF is used as a byte-order mark (BOM), and is often written as the first character of a file in order to assist with auto detection of the fileâ€™s byte ordering. )</p> <ul> <li> <p>ONE important concept is that, in Python, only refer to store or transmit strings when talking about encodings.</p> </li> <li>Using code point can display unicode string! utf-32 can be represented by codepoint totally. But this encoding have some shortcoming. like consuming too many space, byte ordering issue.</li> <li>Python say it represent string with code point internally. it is possible and it is good to support string methods. The encoding can be ASCII, or USC2, or USC4. But user can store or transmit string by UTF-8</li> </ul> <p>â€“ How to change str encoding. In Python, str type is Unicode string. strâ€™s encoding just for store or transmission. str.encode() support around 100 encoding type.</p> <p>â€“ How to know the encoding of one String? How do Python identify the encoding of one string? Encoding is out-of-band. You cannot infer the encoding of bytes. You must be told, or you have to guess.</p> <p>â€“ How to judge the string if we just get part of the string? UTF-8 performing better at this issue.</p> <p>â€“ How to indexing, slicing, getting length of a Unicode String? Variable length encoding can make indexing slicing getting length fail. Pythonâ€™s string type is using Unicode, but internal encoding is vary which depending on what characters the string contains.</p> <p>â€“ What is the relationship between string interning and encoding? Not relative</p> <p>â€” List</p> <ul> <li>List is ordered and mutable, Allows duplicate members, similar to array in JavaScript.</li> <li> <p>Lists are created using square brackets. Example: list1 = [â€œabcâ€, 34, True, 40, â€œmaleâ€]</p> </li> <li>If you want to determine something inside of a List, that is big O(n) time complexity. It look over most of the elements of the list. But for Set or Dict, it is constant time complexity.</li> <li>If you pop the last element of the list, it is constant time operation. But remove the first element, then it is O(n) operation.</li> <li>If you need to have an order collection of elements, you want to pop at the end or beginning or middle of it. You should use the following two data structure: from collections import deque, queue</li> </ul> <p>â€” list comprehension syntax</p> <p>List comprehension is an elegant way to create lists based on existing lists.</p> <p>â€” Syntax: newlist = [expression for item in iterable if condition == True]</p> <ul> <li> <p>A list comprehension consists of brackets containing an expression followed by a for clause, then zero or more for or if clauses.</p> </li> <li> <p>The result will be a new list resulting from evaluating the expression in the context of the for and if clauses which follow it. For example, this listcomp combines the elements of two lists if they are not equal:</p> </li> </ul> <blockquote> <blockquote> <blockquote> <p>[(x, y) for x in [1,2,3] for y in [3,1,4] if x != y] [(1, 3), (1, 4), (2, 3), (2, 1), (2, 4), (3, 1), (3, 4)]</p> </blockquote> </blockquote> </blockquote> <ul> <li>Key point: the first for loop is outer loop. But you can use bracket to wrap expression and for loop together, and make second for loop outside:</li> </ul> <p>matrix = [[1, 2], [3,4], [5,6], [7,8]]</p> <h1 id="flat-2d-list-to-1-2-3-4-5-6-7-8">Flat 2D list to [1, 2, 3, 4, 5, 6, 7, 8]:</h1> <p>print([j for i in matrix for j in i])</p> <h1 id="transpose-to-1-3-5-7-2-4-6-8">Transpose to [1, 3, 5, 7], [2, 4, 6, 8]]:</h1> <p>print([[row[i] for row in matrix] for i in range(2)])</p> <p>â€” Features â€“ The condition is like a filter, and it is optional: fruits = [â€œappleâ€, â€œbananaâ€, â€œcherryâ€, â€œkiwiâ€, â€œmangoâ€] newlist = [x for x in fruits if â€œaâ€ in x] print(newlist) # [â€˜appleâ€™, â€˜bananaâ€™, â€˜mangoâ€™]</p> <p>â€“ The expression can also contain conditions, not like a filter, but as a way to manipulate the outcome: fruits = [â€œappleâ€, â€œbananaâ€, â€œcherryâ€, â€œkiwiâ€, â€œmangoâ€] newlist = [x if x != â€œbananaâ€ else â€œorangeâ€ for x in fruits] print(newlist) # fruits = [â€œappleâ€, â€œorangeâ€, â€œcherryâ€, â€œkiwiâ€, â€œmangoâ€]</p> <p>â€“ Support nested list comprehension</p> <p>â€” Common methods</p> <p>â€” Access List items</p> <ul> <li>s[i] ith item of s, origin 0</li> <li>s[i:j] slice of s from i to j</li> <li>s[i:j:k] slice of s from i to j with step k</li> </ul> <p>â€” Modifying List</p> <ul> <li>append() method</li> <li>insert() method</li> <li>support operator: +, *, +=, *=</li> </ul> <p>â€” Remove List Items</p> <ul> <li>remove() method removes the specified item</li> <li>pop() method removes the specified index.</li> <li>The del keyword also removes the specified index</li> <li>clear() method empties the list.</li> </ul> <p>â€” reverse()</p> <p>â€” sort()</p> <ul> <li>It will sort the list alphanumerically, ascending, by default.</li> <li>Sort the list descending: lst.sort(reverse = True)</li> </ul> <p>â€” Copy a list Thre are 3 ways to copy a list: 1. newlst = lst.copy() 2. newlst = list(lst) 3. newlst = [i for i in lst]</p> <p>â€” Join two list 1, list3 = list1 + list2 2, Another way to join two lists is by appending all the items from list2 into list1, one by one. 3, Use the extend() method to add list2 at the end of list1 list1.extend(list2)</p> <p>â€” Multi-Dimensional Arrays Operation</p> <ul> <li>When deal with Multi-Dimensional Arrays, it is good to use NumPy.</li> </ul> <p>â€“ What do X[:,1] means</p> <ul> <li>X is a numpy array, and it is Multi-Dimensional Array.</li> <li>Say Here X have n rows and n columns</li> <li>so by doing x=x[:,1] we get all the rows in x present at index 1.</li> </ul> <p>â€“ for example:</p> <p>x = array([ [0.69859393, 0.1042432 ], [0.55138493, 0.18639614], [0.27338772, 0.80351282]])</p> <p>x[:,1] = array([0.1042432 , 0.18639614, 0.80351282])</p> <p>â€” Understanding Lists in Python</p> <p>â€” What is Array in Python</p> <ul> <li> <p>An array is a set of elements which â‘  have the same size, â‘¡ located in memory one after another, without gaps.</p> </li> <li> <p>Since the â€œget value by addressâ€ memory operation takes constant time, selecting an array item by index also takes O(1).</p> </li> </ul> <p>â€“ Array vs. List</p> <p>â€” List is kind of array</p> <ul> <li>The list is based on the array.</li> </ul> <p>â€“ List = Array of Pointers</p> <ul> <li>The list instantly retrieves an item by index (O(1)), because it has an array inside.</li> <li>And the array is so fast because all the elements are the same size.</li> <li>For example: <blockquote> <blockquote> <blockquote> <p>sys.getsizeof([â€˜1â€™]) 64 sys.getsizeof([â€˜1â€™,â€™2â€™]) 72 sys.getsizeof([â€˜a long long long stringâ€™]) 64</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€“ List = Dynamic Array</p> <ul> <li>The list juggles arrays all the time so that we donâ€™t have to do it . For example, if array is full, it will allocate new memory for all elements.</li> <li>You can even check all detail in Python c code.</li> </ul> <p>â€“ these operations are O(1):</p> <ul> <li>select an item by index lst[idx]</li> <li>count items len(lst)</li> <li>add an item to the end of the list .append(item)</li> <li>remove an item from the end of the list .pop()</li> </ul> <p>â€“ operations are â€œslowâ€:</p> <ul> <li>Insert or delete an item by index. .insert(idx, item) and .pop(idx) take linear time O(n) because they shift all the elements after the target one.</li> <li>Search or delete an item by value. item in lst, .index(item) and .remove(item) take linear time O(n) because they iterate over all the elements.</li> <li>Select a slice of k elements. lst[from:to] takes O(k).</li> </ul> <p>â€” Conclusion</p> <ul> <li>Now you can understand why Memory of list is like that: it depond on how many members instead of how big of the members.</li> <li>You can understand why some operations are quick, but some are slow.</li> </ul> <p>â€” Questions</p> <p>â€” Do Python allocate new memory for the following variable small_list? big_list = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] small_list = big_list[:5] Ask yourself if you modify small_list, do big_list modify as well? if not, then new memory.</p> <p>â€” Tuple</p> <p>â€” What is Tuple</p> <ul> <li>A tuple is a sequence which is ordered and Immutable, Allows duplicate.</li> <li>Tuples are unchangeable, meaning that we cannot change, add or remove items after the tuple has been created. However, if a member of the tuple is list, list content can be changed.</li> <li>But there is a workaround. You can convert the tuple into a list, change the list, and convert the list back into a tuple.</li> <li>Tuples are written with round brackets: tuple1 = (â€œabcâ€, 34, True, 40, â€œmaleâ€)</li> </ul> <p>â€“ Tuple Features</p> <ul> <li>Tuple is immutable, but it will instantiated without checking memory. It donâ€™t like many immutable, e.g. int, float, check memory for same value instance.</li> <li>Tuple have quirk syntax when it contain 0 or 1 items. t = ()<br/> t = (1,)</li> </ul> <p>â€“ Access Tuple.</p> <ul> <li>using [].</li> <li>using keyword â€˜inâ€™.</li> </ul> <p>â€“ Update Tuple Convert the tuple into a list, update, and convert it back into a tuple.</p> <p>â€“ Unpacking a Tuple When create a tuple, normally assign values to it. This is called â€œpackingâ€ a tuple. Tuple allowed to extract the values back into variables. This is called â€œunpackingâ€. (Call destructuring assignment in JavaScript)</p> <p>fruits = (â€œappleâ€, â€œbananaâ€, â€œcherryâ€) (green, yellow, red) = fruits</p> <p>Add an * to the variable name and the values will be assigned to the variable as a list: fruits = (â€œappleâ€, â€œbananaâ€, â€œcherryâ€, â€œstrawberryâ€, â€œraspberryâ€) (green, yellow, *red) = fruits</p> <p>â€“ You join Tuples by using â€˜+â€™, multiply Tuples by using â€˜*â€™</p> <p>â€” Range</p> <ul> <li>Range is built-in type in Python.</li> <li>The range type represents an immutable sequence of numbers and is commonly used for looping a specific number of times in for loops.</li> </ul> <p>â€” Range is not a generator</p> <ul> <li>Many people have some misunderstanding, but range is not a generator, itâ€™s not any kind of iterator.</li> <li>If it were a generator, iterating it once would exhaust it, but: <blockquote> <blockquote> <blockquote> <p>a = range(5) print(list(a)) [0, 1, 2, 3, 4] print(list(a)) [0, 1, 2, 3, 4]</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€” Range is sequence</p> <ul> <li>Range actually is a sequence. it is a smart sequence object that produces numbers on demand.</li> <li>Range doesnâ€™t remember all of its values, it just remembers its start, stop, and step, and creates the values on demand on <strong>getitem</strong>.</li> <li> <p>The range object implements the object.<strong>contains</strong> hook, and calculates if your number is part of its range when you use keyword in. There is never a need to scan through all possible integers in the range.</p> </li> <li> <p>The difference between a range and a list is that a range is a lazy or dynamic sequence;</p> </li> <li>The advantage of the range type over a regular list or tuple is that a range object will always take the same (small) amount of memory, no matter the size of the range it represents (as it only stores the start, stop and step values, calculating individual items and subranges as needed).</li> </ul> <p>â€” Set</p> <p>â€” What is Set A set object is an unordered collection of distinct hashable objects. Like other collections, sets support x in set, len(set), and for x in set. Python have set and frozen set.</p> <ul> <li>Set support comprehension syntax as well, similar to list comprehension.</li> </ul> <p>â€“ Common uses include</p> <ul> <li>membership testing,</li> <li>removing duplicates from a sequence,</li> <li>Provide computing mathematical operations such as intersection, union, difference, and symmetric difference.</li> </ul> <p>â€” set These represent a mutable â€” the contents can be changed using methods like add() and remove(). Since it is mutable, it has no hash value and cannot be used as either a dictionary key or as an element of another set.</p> <ul> <li>A set is a collection which is unordered, Not allow duplicates.</li> <li>We cannot change the items after the set has been created. but you can remove items and add new items.</li> <li>Sets are written with curly brackets: set1 = {â€œabcâ€, 34, True, 40, â€œmaleâ€}</li> </ul> <p>â€” frozenset These represent an immutable set. As a frozenset is immutable and hashable, it can be used again as an element of another set, or as a dictionary key.</p> <p>â€” Instances of set and frozenset provide the following operations: (You can tell what set and frozenset can do according this operations)</p> <p>â€“ len(s) Return the number of elements in set s (cardinality of s).</p> <p>â€“ x in s Test x for membership in s.</p> <p>â€“ x not in s Test x for non-membership in s.</p> <p>â€“ isdisjoint(other) Return True if the set has no elements in common with other. Sets are disjoint if and only if their intersection is the empty set.</p> <p>â€“ issubset(other) set &lt;= other Test whether every element in the set is in other.</p> <p>â€“ set &lt; other Test whether the set is a proper subset of other, that is, set &lt;= other and set != other.</p> <p>â€“ issuperset(other) set &gt;= other Test whether every element in other is in the set.</p> <p>â€“ set &gt; other Test whether the set is a proper superset of other, that is, set &gt;= other and set != other.</p> <p>â€“ union(*others) set | other | â€¦ Return a new set with elements from the set and all others.</p> <p>â€“ intersection(*others) set &amp; other &amp; â€¦ Return a new set with elements common to the set and all others.</p> <p>â€“ difference(*others) set - other - â€¦ Return a new set with elements in the set that are not in the others.</p> <p>â€“ symmetric_difference(other) set ^ other Return a new set with elements in either the set or other but not both.</p> <p>copy() Return a shallow copy of the set.</p> <p>â€” operations available for set, but not frozenset</p> <p>update(*others) set |= other | â€¦ Update the set, adding elements from all others.</p> <p>intersection_update(*others) set &amp;= other &amp; â€¦ Update the set, keeping only elements found in it and all others.</p> <p>difference_update(*others) set -= other | â€¦ Update the set, removing elements found in others.</p> <p>symmetric_difference_update(other) set ^= other Update the set, keeping only elements found in either set, but not in both.</p> <p>add(elem) Add element elem to the set.</p> <p>remove(elem) Remove element elem from the set. Raises KeyError if elem is not contained in the set.</p> <p>discard(elem) Remove element elem from the set if it is present.</p> <p>pop() Remove and return an arbitrary element from the set. Raises KeyError if the set is empty.</p> <p>clear() Remove all elements from the set.</p> <p>â€” Questions</p> <p>â€“ Can Set contains mutable type, like list? NO, elements in set, key in dictionary, have to be hashable. That means it canâ€™t be list or other mutable type. Tuple can be elements of set if it havenâ€™t mutable member.</p> <p>â€” Dictionary</p> <p>â€” What is Dictionary</p> <p>Dictionaries are used to store data values in key:value pairs. A dictionary is a collection which is ordered*, mutable and do not allow duplicates.</p> <p>â€” Features</p> <ul> <li> <p>keys, which can be any immutable type; strings and numbers can always be keys. Tuples can be used as keys if they contain only strings, numbers, or tuples; if a tuple contains any mutable object either directly or indirectly, it cannot be used as a key.</p> </li> <li> <p>As of Python version 3.7, dictionaries are ordered. In Python 3.6 and earlier, dictionaries are unordered.</p> </li> <li> <p>Use curl bracket: thisdict = { â€œbrandâ€: â€œFordâ€, â€œmodelâ€: â€œMustangâ€, â€œyearâ€: 1964 }</p> </li> <li>The dict() constructor builds dictionaries directly from sequences of key-value pairs: <blockquote> <blockquote> <blockquote> <p>dict([(â€˜sapeâ€™, 4139), (â€˜guidoâ€™, 4127), (â€˜jackâ€™, 4098)]) {â€˜sapeâ€™: 4139, â€˜guidoâ€™: 4127, â€˜jackâ€™: 4098}</p> </blockquote> </blockquote> </blockquote> </li> <li>dict comprehensions can be used to create dictionaries from arbitrary key and value expressions: <blockquote> <blockquote> <blockquote> <p>{x: x**2 for x in (2, 4, 6)} {2: 4, 4: 16, 6: 36}</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€” Operation Methods</p> <p>â€” Accessing Items</p> <ul> <li>Dictionary is in order. But have no idea to access it by order.</li> </ul> <p>â€“ Access directly thisdict = { â€œbrandâ€: â€œFordâ€, â€œmodelâ€: â€œMustangâ€, } print(thisdict[â€œmodelâ€])</p> <ul> <li> <p>using square bracket [] is equivalent to <strong>getitem</strong>()</p> </li> <li> <p>if visit key that doesnâ€™t exist It will raise KeyError. But you can override the <strong>missing</strong>(self, key) method defines the behavior of a dictionary subclass if you access a non-existent key. More specifically, Pythonâ€™s <strong>getitem</strong>() dictionary method internally calls the <strong>missing</strong>() method if the key doesnâ€™t exist. The return value of <strong>missing</strong>() is the value to be returned when trying to access a non-existent key.</p> </li> </ul> <p>â€“ keys(), values(), items()</p> <ul> <li>return view objects for corresponded things.</li> <li>Dictionary view object provide a dynamic view on the dictionaryâ€™s entries, which means that when the dictionary changes, the view reflects these changes.</li> <li>Keys views are set-like!</li> <li>If all values are hashable, then the items view is also set-like.</li> <li>Values views are not treated as set-like.</li> <li>For set-like views, all of the operations defined for the abstract base class collections.abc.Set are available (for example, ==, &lt;, or ^).</li> </ul> <p>â€“ setdefault(key[, default]) Returns the value of the specified key. If the key does not exist: insert the key, with the specified value.</p> <ul> <li>keyname is required</li> <li>value is Optional. If the key exist, value has no effect. If the key does not exist, this value becomes the keyâ€™s value. Default value None. print(thisdict.setdefault(â€œmodelâ€,â€Focusâ€))</li> </ul> <p>â€“ get(key[, default]) Return the value for key if key is in the dictionary, else default. If default is not given, it defaults to None.</p> <ul> <li>get() is different function from <strong>getitem</strong>(). They have no connection.</li> </ul> <p>â€” Remove items</p> <p>â€“ pop() The pop() method removes the item with the specified key name. â€“ popitem() The popitem() method removes the last inserted item (in versions before 3.7, a random item is removed instead): â€“ del keyword Can delete items or the dictionary â€“ clear() Clear the dictionary</p> <p>â€” Add items, Change items</p> <p>â€“ add item directly, change directly (list canâ€™t add item directly, but dict can) thisdict = { â€œbrandâ€: â€œFordâ€, â€œmodelâ€: â€œMustangâ€, } thisdict[â€œcolorâ€] = â€œredâ€ thisdict[â€œmodelâ€] = â€œFocusâ€</p> <ul> <li>using square bracket [] is equivalent to <strong>setitem</strong>()</li> </ul> <p>â€“ update() The update() method inserts the specified items to the dictionary.</p> <ul> <li>update() can overwrite the exist key and itâ€™s value.</li> <li>can concatenate dictionarys.</li> <li>can concatenate key value pair iterable object. dictionary.update(iterable) â€¢ iterable can be A dictionary or an iterable object with key value pairs, that will be inserted to the dictionary.</li> </ul> <p>â€“ dict NOT support operator + But Counter can</p> <p>â€“ setdefault() see above</p> <p>â€” Create Dictionary</p> <p>â€“ dict.fromkeys(keys, value) The fromkeys() method returns a dictionary with the specified keys and the specified value.</p> <ul> <li> <p>syntac dict.fromkeys(keys, value) keys: Required. An iterable specifying the keys of the new dictionary value: Optional. The value for all keys. Default value is None</p> </li> <li> <p>an example of how to use dict as an ordered set to filter out duplicate items while preserving order, thereby emulating an ordered set:</p> <blockquote> <blockquote> <blockquote> <p>keywords = [â€˜fooâ€™, â€˜barâ€™, â€˜barâ€™, â€˜fooâ€™, â€˜bazâ€™, â€˜fooâ€™] list(dict.fromkeys(keywords)) [â€˜fooâ€™, â€˜barâ€™, â€˜bazâ€™]</p> </blockquote> </blockquote> </blockquote> </li> </ul> <p>â€“ zip() zip() returns an iterator of tuples, where the i-th tuple contains the i-th element from each of the argument iterables. keys = [â€˜redâ€™, â€˜greenâ€™, â€˜blueâ€™] values = [â€˜#FF0000â€™,â€™#008000â€™, â€˜#0000FFâ€™] color_dictionary = dict(zip(keys, values))</p> <p>â€” Copy Dictionary â€“ copy() Dictionary method copy() can create a new dict according to the current dict.</p> <p>â€“ dict() Another way to make a copy is to use the built-in function dict().</p> <p>â€” Loop over dict for x in thisdict: print(x)</p> <p>x is the key! no value.</p> <p>â€” Question</p> <p>â€” How to get the first item of a dict?</p> <p>â€” Collections</p> <p>â€” Time Complexity of Collections</p> <p>â€” list</p> <ul> <li>Internally, a list is represented as an array;</li> <li>The largest costs come from growing beyond the current allocation size (because everything must move), or from inserting or deleting somewhere near the beginning (because everything after that must move).</li> <li>If you need to add/remove at both ends, consider using a collections.deque instead.</li> </ul> <p>â€” dict</p> <ul> <li> <p>There is a fast-path for dicts that (in practice) only deal with str keys;</p> </li> <li> <p>Python have a typical space-time tradeoff in dictionaries and lists. It means we can decrease the time necessary for our algorithm but we need to use more space in memory for dictionaries.</p> </li> <li> <p>time complexity x in s operation for dict is O(1); But for list if O(n).</p> </li> </ul> <p>â€” set</p> <p>See dict â€“ the implementation is intentionally very similar.</p> <p>â€” collections.deque</p> <p>A deque (double-ended queue) is represented internally as a doubly linked list. (Well, a list of arrays rather than objects, for greater efficiency.) Both ends are accessible, but even looking at the middle is slow, and adding to or removing from the middle is slower still.</p> <p>â€” collections.defaultdict</p> <p>(you can write a subclass of dictionary which is same with defaultdict easily)</p> <p>â€” What is defaultdict</p> <ul> <li>defaultdict(default_factory=None) Return a new dictionary-like object.</li> <li>The first argument provides the initial value for the default_factory attribute; it muse be callable or None.</li> <li> <p>You can following function to name a constant value for the default_factory: def constant_factory(value): return lambda: value</p> </li> <li>defaultdict is a subclass of the built-in dict class. It overrides one method (<strong>missing</strong>()) and adds one variable (default_factory). The remaining functionality is the same as for the dict class.</li> <li><strong>missing</strong>() is called by the <strong>getitem</strong>() method of the dict class when the requested key is not found;</li> </ul> <p>â€” Why need defaultdict</p> <ul> <li>you can define the default type for the dictionary value. Then when you canâ€™t find the corresponded value, you will get default value and itâ€™s type and use corresponded method.</li> </ul> <p>â€” Following example can to understand defaultdict!</p> <p>â€“ Example1: Using list as the default_factory, it is easy to group a sequence of key-value pairs into a dictionary of lists:</p> <p>s = [(â€˜yellowâ€™, 1), (â€˜blueâ€™, 2), (â€˜yellowâ€™, 3), (â€˜blueâ€™, 4), (â€˜redâ€™, 1)] d = defaultdict(list) for k, v in s: d[k].append(v)</p> <h1 id="d-will-be-yellow-1-3-blue-2-4-red-1">d will be {â€˜yellowâ€™: [1, 3], â€˜blueâ€™: [2, 4], â€˜redâ€™: [1]})</h1> <p>â€“ Example2: Setting the default_factory to int makes the defaultdict useful for counting (like a bag or multiset in other languages):</p> <p>s = â€˜mississippiâ€™ d = defaultdict(int) for k in s: d[k] += 1</p> <p>sorted(d.items()) [(â€˜iâ€™, 4), (â€˜mâ€™, 1), (â€˜pâ€™, 2), (â€˜sâ€™, 4)]</p> <p>â€“ Example3: Setting the default_factory to set makes the defaultdict useful for building a dictionary of sets:</p> <p>s = [(â€˜redâ€™, 1), (â€˜blueâ€™, 2), (â€˜redâ€™, 3), (â€˜blueâ€™, 4), (â€˜redâ€™, 1), (â€˜blueâ€™, 4)] d = defaultdict(set) for k, v in s: d[k].add(v)</p> <p>sorted(d.items()) [(â€˜blueâ€™, {2, 4}), (â€˜redâ€™, {1, 3})]</p> <p>â€” collections.Counter</p> <p>â€” What is Counter</p> <ul> <li>It is a collection where elements are stored as dictionary keys and their counts are stored as dictionary values.</li> <li>Counts are allowed to be any integer value including zero or negative counts.</li> <li>A Counter is a dict subclass for counting hashable objects.</li> </ul> <p>â€“ Syntax: collections.Counter([iterable-or-mapping])</p> <p>â€“ Features</p> <ul> <li>The usual dictionary methods are available for Counter objects except for two which work differently for counters. They are udpate(), fromkeys()</li> <li>Counter support additional methods: elements(), most_common(), total(), subtract()</li> <li> <table> <tbody> <tr> <td>Counter support operator + , - , &amp;,</td> </tr> </tbody> </table> </li> </ul> <p>â€” Why Counter Following examples is common way to use counter. They should give you some ideas:</p> <p>â€“ Get common items</p> <blockquote> <blockquote> <blockquote> <p>Counter(â€˜abracadabraâ€™).most_common(3) [(â€˜aâ€™, 5), (â€˜bâ€™, 2), (â€˜râ€™, 2)]</p> </blockquote> </blockquote> </blockquote> <p>â€“ list elements</p> <blockquote> <blockquote> <blockquote> <p>c = Counter(a=4, b=2, c=0, d=-2) sorted(c.elements()) [â€˜aâ€™, â€˜aâ€™, â€˜aâ€™, â€˜aâ€™, â€˜bâ€™, â€˜bâ€™]</p> </blockquote> </blockquote> </blockquote> <p>â€“ counter + counter</p> <blockquote> <blockquote> <blockquote> <p>c = Counter(a=3, b=1) d = Counter(a=1, b=2) c + d # add two counters together: c[x] + d[x] Counter({â€˜aâ€™: 4, â€˜bâ€™: 3})</p> </blockquote> </blockquote> </blockquote> <p>â€“ counter[key] +=</p> <blockquote> <blockquote> <blockquote> <p>c = Counter(a=3, b=1) d = Counter(a=1, b=2) c[â€˜aâ€™] += d [â€˜aâ€™] Counter({â€˜aâ€™: 4, â€˜bâ€™: 1})</p> </blockquote> </blockquote> </blockquote> <p>â€” Context Manager Types</p> <p>â€” What is Context Manager</p> <p>(https://peps.python.org/pep-0343/)</p> <ul> <li> <p>A context manager is an object that defines the runtime context to be established when executing a with statement.</p> </li> <li> <p>The context manager handles the entry into, and the exit from, the desired runtime context for the execution of the block of code.</p> </li> <li> <p>Context managers are normally invoked using the with statement, but can also be used by directly invoking their methods.</p> </li> </ul> <p>â€” The with statement The with statement is used to wrap the execution of a block with methods defined by a context manager. This allows common tryâ€¦exceptâ€¦finally usage patterns to be encapsulated for convenient reuse.</p>]]></content><author><name></name></author><category term="Python"/><category term="Python"/><summary type="html"><![CDATA[JavaScript have primitive type concept. But Python donâ€™t.]]></summary></entry><entry><title type="html">Python Overview</title><link href="https://benwzj.github.io/blog/2024/python/" rel="alternate" type="text/html" title="Python Overview"/><published>2024-12-11T00:00:00+00:00</published><updated>2024-12-11T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/python</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/python/"><![CDATA[<ul> <li>Python is an object oriented programming language.</li> <li>Almost everything in Python is an object, with its properties and methods.</li> <li>A Class is like an object constructor, or a â€œblueprintâ€ for creating objects.</li> <li>Different from JavaScript, there are no primitives in Python.</li> </ul> <h2 id="python-vs-javascript">Python vs. JavaScript</h2> <h3 id="repl">REPL</h3> <p>REPL(Read-Eval-Print-Loop)</p> <ul> <li>Python has itâ€™s own interpreter. And Python have different version interpreter. For example Pythone 2.7 still popular, but the new stable version is 3.10 at the moment. something like: python3 yourcode.py</li> <li>JavaScript need a JavaScript runtime to support, like Browser, NodeJS.</li> </ul> <h3 id="code-blocks">Code Blocks</h3> <ul> <li>JavaScript makes use of curly brackets for defining code blocks. Python, on the other hand, uses indentation for defining code blocks.</li> <li>While JavaScript has the semi-colon (;) that serves as the statement terminator (though it is not mandatory), Python uses a newline.</li> </ul> <h3 id="data-type">Data type</h3> <h4 id="mutability">Mutability</h4> <ul> <li>Python support mutable data type, like set, and immutable data type, like list.</li> <li>JavaScript have primitive type concept which are immutable. All object is mutable. But each property of the object have itâ€™s own descriptor which can config the mutability of the property.</li> </ul> <h4 id="number">Number</h4> <ul> <li>In python, there are different numeric type like int, float, fixed-point decimal.</li> <li>In JavaScript, there are number and bigInt. Number type is double floating point number.</li> </ul> <h4 id="object">Object</h4> <ul> <li>Objects are Pythonâ€™s abstraction for data. All data in a Python program is represented by objects or by relations between objects. (Everything in python is object)</li> <li>Is it everything is object in JavaScript? NO, primitive is not object.</li> <li>Object in JavaScript, is very easy to create. But in Python, Each object has a class from which it is instantiated.</li> <li>In JavaScript, a simple iterator can be:</li> </ul> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">let</span> <span class="n">myIter</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">n</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nb">next</span><span class="p">:</span> <span class="nf">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">this</span><span class="p">.</span><span class="n">n</span><span class="o">++</span><span class="p">,</span> <span class="n">done</span><span class="p">:</span> <span class="n">false</span><span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <ul> <li>In Python, a iterator looks like:</li> </ul> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyNumbers</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">self</span>

  <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">n</span>

<span class="n">myclass</span> <span class="o">=</span> <span class="nc">MyNumbers</span><span class="p">()</span>
<span class="n">myiter</span> <span class="o">=</span> <span class="nf">iter</span><span class="p">(</span><span class="n">myclass</span><span class="p">)</span>
<span class="nf">next</span><span class="p">(</span><span class="n">myiter</span><span class="p">)</span>
</code></pre></div></div> <h3 id="class">Class</h3> <h4 id="javascript-class">JavaScript class</h4> <ul> <li>JavaScript class, which have been described as syntax sugar, is build on the top of prototype chain.</li> <li>JavaScript class works very well. You donâ€™t need to always translate back to prototype chain to understand the code.</li> <li>JavaScript actually implement class as function.</li> <li>JavaScript class support class, new, constructor, extends, super, static key words. JavaScript class put everything in one place, to implement OOP coding concept which similar to Java, C++.</li> </ul> <h4 id="python-class">Python class</h4> <ul> <li>Each value is an object. Each object is an instance of a class. Even a class is an instance of the metaclass - type.</li> <li>class itself is an object. class instance is an object too.</li> <li>class in python is not function.</li> <li>Method object is not Function object in Python! But they are same thing in JavaScript.</li> <li>Python supports a form of multiple inheritance. But JavaScript support just one.</li> </ul> <h3 id="iterable-iterator">iterable, iterator</h3> <h4 id="javascript">JavaScript</h4> <ul> <li>An object is iterable if it implement the @@iterator method.</li> <li>An object is iterator when it implements the <code class="language-plaintext highlighter-rouge">next()</code> according to some semantics: <code class="language-plaintext highlighter-rouge">done_value_object = myIterator.next(). </code> // if done == false, can keep calling <code class="language-plaintext highlighter-rouge">myIterator.next()</code> to return done_value_object. // if done == true, then iterator is completed.</li> </ul> <h4 id="python">Python</h4> <p>Python have different concepts of iterator and iterable from JavaScript.</p> <ul> <li>exception StopIteration is used to signal the end of an iteration.</li> <li>built-in function <code class="language-plaintext highlighter-rouge">iter()</code> and <code class="language-plaintext highlighter-rouge">next()</code> used to implement iteration.</li> </ul> <h3 id="generator">generator</h3> <h4 id="javascript-generator">JavaScript generator</h4> <ul> <li>syntax: <code class="language-plaintext highlighter-rouge">* function (){}</code></li> <li>generator is an iterator which maintain by the language itself.</li> <li>a generator object (iterator) for the function will be returned when meet yield.</li> <li>yield will return value.</li> <li>generator function also support return keyword. generator function will totally complete when return.</li> <li>generator can work with promise to make code better.</li> </ul> <h4 id="python-generator">Python generator</h4> <ul> <li>syntax: when a function contain keyword yield, then it is generator.</li> <li>If you used <code class="language-plaintext highlighter-rouge">next()</code> after iteration have been completed, then youâ€™ll get an explicit StopIteration exception.</li> </ul> <h3 id="static-method">Static method</h3> <p>static concept is similar between Python, JavaScript, C++, Java. static methods can be accessed from classes instead of instants.</p> <h4 id="in-javascript">in JavaScript</h4> <ul> <li>there are static keyword.</li> <li>static method canâ€™t be access by instance.</li> </ul> <h4 id="in-python">in Python</h4> <ul> <li> <p>Using built-in function staticmethod() to turn method to static. But can using syntaxtic sugar decorator @staticmethod</p> </li> <li> <p>static methods can be access both by class and instance. <code class="language-plaintext highlighter-rouge">Class.staticmethodFunc()</code> or even <code class="language-plaintext highlighter-rouge">Class().staticmethodFunc()</code></p> </li> </ul>]]></content><author><name></name></author><category term="Python"/><category term="Python"/><category term="JavaScript"/><summary type="html"><![CDATA[Python is an object oriented programming language. Almost everything in Python is an object, with its properties and methods. A Class is like an object constructor, or a â€œblueprintâ€ for creating objects. Different from JavaScript, there are no primitives in Python.]]></summary></entry><entry><title type="html">OAuth Flow Details</title><link href="https://benwzj.github.io/blog/2024/oauth-flow/" rel="alternate" type="text/html" title="OAuth Flow Details"/><published>2024-12-07T00:00:00+00:00</published><updated>2024-12-07T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/oauth-flow</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/oauth-flow/"><![CDATA[<p>OAuth is a standard. There are many company implement OAuth according to this Standard. The implementation should be very similar.</p> <p>First of all, you need to create OAuth App in Authorization Server.</p> <p>In OAuth Flow, usually there are some Roles:</p> <ul> <li>User</li> <li>Browser</li> <li>Website App</li> <li> <p>The Authorization Server</p> </li> <li>resource owner (User)</li> <li>resource server</li> <li>client (Website App)</li> <li>authorization server</li> </ul> <p>There are different OAuth Flow for defferent app types:</p> <ul> <li>Single-page app (SPA)</li> <li>Web app</li> <li>Web API</li> <li>Mobile and native apps</li> <li>Service, daemon, script</li> </ul> <h2 id="web-app-flow">Web app flow</h2> <p>(github implementation)</p> <p>The web application flow to authorize users for your app is:</p> <ol> <li>Users are redirected to request their GitHub identity</li> <li>Users are redirected back to your site by GitHub</li> <li>Your app accesses the API with the userâ€™s access token</li> </ol> <h3 id="1-request-a-users-github-identity">1. Request a userâ€™s GitHub identity</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET https://github.com/login/oauth/authorize
</code></pre></div></div> <p>This endpoint takes the following input parameters.</p> <ul> <li><code class="language-plaintext highlighter-rouge">client_id</code> string Required</li> <li><code class="language-plaintext highlighter-rouge">redirect_uri</code> string Strongly recommended</li> <li><code class="language-plaintext highlighter-rouge">login</code> string Optional</li> <li><code class="language-plaintext highlighter-rouge">scope</code> string Context dependent</li> <li><code class="language-plaintext highlighter-rouge">state</code> string Strongly recommended</li> </ul> <h3 id="2-users-are-redirected-back-to-your-site-by-github">2. Users are redirected back to your site by GitHub</h3> <p>If the user accepts your request, GitHub redirects back to your site with a temporary code(authorization code) in a code parameter as well as the state you provided in the previous step in a state parameter.</p> <p>Exchange this code for an access token:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST https://github.com/login/oauth/access_toke
</code></pre></div></div> <p>This endpoint takes the following input parameters.</p> <ul> <li><code class="language-plaintext highlighter-rouge">client_id</code> string Required</li> <li><code class="language-plaintext highlighter-rouge">client_secret</code> string Required</li> <li><code class="language-plaintext highlighter-rouge">code</code> string Required</li> <li><code class="language-plaintext highlighter-rouge">redirect_uri</code> string Strongly recommended</li> </ul> <p>By default, the response takes the following form:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>access_token=gho_16C7e42F292c6912E7710c838347Ae178B4a&amp;scope=repo%2Cgist&amp;token_type=bearer
</code></pre></div></div> <h3 id="3-use-the-access-token-to-access-the-api">3. Use the access token to access the API</h3> <p>The access token allows you to make requests to the API on a behalf of a user.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Authorization: Bearer OAUTH-TOKEN
GET https://api.github.com/user
</code></pre></div></div> <p>For example, in curl you can set the Authorization header like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -H "Authorization: Bearer OAUTH-TOKEN" https://api.github.com/user
</code></pre></div></div> <p>Every time you receive an access token, you should use the token to revalidate the userâ€™s identity. A user can change which account they are signed into when you send them to authorize your app,</p> <figure> <picture> <img src="/assets/img/oauth_web_server_flow.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <p>Another one:</p> <figure> <picture> <img src="/assets/img/oauth-flow.webp" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="about-redirect_uri">About Redirect_URI</h3> <p>Redirect_RUI need be defined in the Authorization Server. And When User is using GET and POST to access Authorization Server, it can use the <code class="language-plaintext highlighter-rouge">redirect_uri</code> parameter.</p> <ul> <li>If left out, GitHub will redirect users to the callback URL configured in the OAuth app settings.</li> <li>If provided, the redirect URLâ€™s host (excluding sub-domains) and port must exactly match the callback URL. The redirect URLâ€™s path must reference a subdirectory of the callback URL.(I spent whole day to figure out this mismatch error)</li> </ul> <h4 id="loopback-redirect-urls">Loopback redirect urls</h4> <p>The optional <code class="language-plaintext highlighter-rouge">redirect_uri</code> parameter can also be used for loopback URLs, which is useful for native applications running on a desktop computer. If the application specifies a loopback URL and a port, then after authorizing the application users will be redirected to the provided URL and port. The <code class="language-plaintext highlighter-rouge">redirect_uri</code> does not need to match the port specified in the callback URL for the app.</p> <p>You can use <code class="language-plaintext highlighter-rouge">http://127.0.0.1:1234/path</code> as <code class="language-plaintext highlighter-rouge">redirect_uri</code>.</p> <blockquote> <p>Note that OAuth RFC recommends not to use <code class="language-plaintext highlighter-rouge">localhost</code>, but instead to use loopback literal <code class="language-plaintext highlighter-rouge">127.0.0.1</code> or <code class="language-plaintext highlighter-rouge">IPv6 ::1</code>.</p> </blockquote> <h2 id="single-page-app-flow">Single-page app flow</h2> <p>Many modern apps have a single-page app (SPA) front end written primarily in JavaScript, often with a framework like Angular, React, or Vue.</p> <p>Single-page apps (or browser-based apps) run entirely in the browser after loading the source code from a web page. Since the entire source code is available to the browser, they cannot maintain the confidentiality of a client secret, so the secret is not used in this case.</p> <p>Previously, it was recommended that browser-based apps use the â€œImplicitâ€ flow, which returns an access token immediately in the redirect and does not have a token exchange step. In the time since the spec was originally written, the industry best practice has changed to recommend that the <strong>authorization code</strong> flow be used without the client secret. This provides more opportunities to create a secure flow, such as using the <code class="language-plaintext highlighter-rouge">Proof Key for Code Exchange (PKCE)</code> extension.</p> <h3 id="pkce">PKCE</h3> <p>PKCE-enhanced Authorization Code Flow builds upon the standard Authorization Code Flow, the steps are very similar with Web app flow. But with the addition of a dynamically generated secret used on each request. This is known as the PKCE extension.</p> <blockquote> <p>The main difference between Implicit and PKCE flow is ADDing <strong>authorization code</strong>.</p> </blockquote> <p>Definition of Proof Key for Code Exchange (PKCE) <a href="https://datatracker.ietf.org/doc/html/rfc7636">OAuth 2.0 RFC 7636</a>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                                 +-------------------+
                                                 |   Authz Server    |
       +--------+                                | +---------------+ |
       |        |--(A)- Authorization Request ----&gt;|               | |
       |        |       + t(code_verifier), t_m  | | Authorization | |
       |        |                                | |    Endpoint   | |
       |        |&lt;-(B)---- Authorization Code -----|               | |
       |        |                                | +---------------+ |
       | Client |                                |                   |
       |        |                                | +---------------+ |
       |        |--(C)-- Access Token Request ----&gt;|               | |
       |        |          + code_verifier       | |    Token      | |
       |        |                                | |   Endpoint    | |
       |        |&lt;-(D)------ Access Token ---------|               | |
       +--------+                                | +---------------+ |
                                                 +-------------------+
</code></pre></div></div> <h2 id="references">References</h2> <ul> <li>The OAuth 2.0 Authorization Framework<a href="https://datatracker.ietf.org/doc/html/rfc6749">RFC 6749</a></li> <li>Proof Key for Code Exchange by OAuth Public Clients<a href="https://datatracker.ietf.org/doc/html/rfc7636">RFC 7636</a></li> </ul>]]></content><author><name></name></author><category term="Auth"/><category term="Authentication"/><category term="github"/><category term="Authorization"/><category term="OAuth"/><summary type="html"><![CDATA[OAuth is a standard. There are many company implement OAuth according to this Standard. The implementation should be very similar.]]></summary></entry><entry><title type="html">TypeScript Operators</title><link href="https://benwzj.github.io/blog/2024/ts-operators/" rel="alternate" type="text/html" title="TypeScript Operators"/><published>2024-11-27T00:00:00+00:00</published><updated>2024-11-27T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/ts-operators</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/ts-operators/"><![CDATA[<h2 id="satisfies-operator">satisfies Operator</h2> <p>TypeScript developers are often faced with a dilemma: we want to ensure that some expression matches some type, but also want to keep the most specific type of that expression for inference purposes.</p> <p>That means, You donâ€™t have to use type annotation to define a variable in order to make it matches specific type. When you use type annotation to define a variable, this variable will be taken as the specific type. At this point, this variable will under the constraint of the specific type. In some case, you may just want to make sure the variable in the shape of specific type but donâ€™t want the constraint. Then use satisfies operatior.</p> <h3 id="not-care-about-property-name-just-care-about-the-type-of-property">Not care about property name, Just care about the type of property</h3> <p>Maybe we donâ€™t care about if the property names match up somehow, but we do care about the types of each property. In that case, we can also ensure that all of an objectâ€™s property values conform to some type. Like this:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">RGB</span> <span class="o">=</span> <span class="p">[</span><span class="nx">red</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">green</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">blue</span><span class="p">:</span> <span class="kr">number</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">palette</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">red</span><span class="p">:</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="na">green</span><span class="p">:</span> <span class="dl">"</span><span class="s2">#00ff00</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">blue</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">//   will catch this error!</span>
<span class="p">}</span> <span class="kd">satisfies </span><span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">string</span> <span class="o">|</span> <span class="nx">RGB</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">// Information about each property is still maintained.</span>
<span class="kd">const</span> <span class="nx">redComponent</span> <span class="o">=</span> <span class="nx">palette</span><span class="p">.</span><span class="nx">red</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// this still work</span>
<span class="kd">const</span> <span class="nx">greenNormalized</span> <span class="o">=</span> <span class="nx">palette</span><span class="p">.</span><span class="nx">green</span><span class="p">.</span><span class="nf">toUpperCase</span><span class="p">();</span> <span class="c1">// this still work</span>
</code></pre></div></div> <h3 id="ensure-that-an-object-has-all-the-keys-of-some-type-but-no-more">ensure that an object has all the keys of some type, but no more:</h3> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">Colors</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">red</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">green</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">blue</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// Ensure that we have exactly the keys from 'Colors'.</span>
<span class="kd">const</span> <span class="nx">favoriteColors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">red</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">yes</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">green</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">blue</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">kinda</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">platypus</span><span class="dl">"</span><span class="p">:</span> <span class="kc">false</span> <span class="c1">//  ~~~~~~~~~~ error - "platypus" was never listed in 'Colors'.</span>
<span class="p">}</span> <span class="kd">satisfies </span><span class="nb">Record</span><span class="o">&lt;</span><span class="nx">Colors</span><span class="p">,</span> <span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">// All the information about the 'red', 'green', and 'blue' properties are retained.</span>
<span class="kd">const</span> <span class="nx">g</span><span class="p">:</span> <span class="nx">boolean</span> <span class="o">=</span> <span class="nx">favoriteColors</span><span class="p">.</span><span class="nx">green</span><span class="p">;</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="TypeScript"/><category term="TypeScript"/><summary type="html"><![CDATA[satisfies Operator]]></summary></entry><entry><title type="html">TypeScript Utility Types</title><link href="https://benwzj.github.io/blog/2024/ts-utility-types/" rel="alternate" type="text/html" title="TypeScript Utility Types"/><published>2024-11-26T00:00:00+00:00</published><updated>2024-11-26T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/ts-utility-types</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/ts-utility-types/"><![CDATA[<p>TypeScript provides several utility types to facilitate common type transformations. These utilities are available globally.</p> <ul> <li>Utility types are <code class="language-plaintext highlighter-rouge">type</code>s.</li> <li>Utility types are used to <strong>transform</strong> one type to anther type.</li> </ul> <h2 id="record">Record</h2> <p><code class="language-plaintext highlighter-rouge">Record&lt;Keys, Type&gt;</code> Constructs an object type whose property keys are <code class="language-plaintext highlighter-rouge">Keys</code> and whose property values are <code class="language-plaintext highlighter-rouge">Type</code>. This utility can be used to map the properties of a type to another type.</p> <p>Need an Example explain it:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">CatName</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">miffy</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">boris</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">mordred</span><span class="dl">"</span><span class="p">;</span>
 
<span class="kr">interface</span> <span class="nx">CatInfo</span> <span class="p">{</span>
  <span class="nl">age</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">breed</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kd">const</span> <span class="nx">cats</span><span class="p">:</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="nx">CatName</span><span class="p">,</span> <span class="nx">CatInfo</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">miffy</span><span class="p">:</span> <span class="p">{</span> <span class="na">age</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">breed</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Persian</span><span class="dl">"</span> <span class="p">},</span>
  <span class="na">boris</span><span class="p">:</span> <span class="p">{</span> <span class="na">age</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="na">breed</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Maine Coon</span><span class="dl">"</span> <span class="p">},</span>
  <span class="na">mordred</span><span class="p">:</span> <span class="p">{</span> <span class="na">age</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="na">breed</span><span class="p">:</span> <span class="dl">"</span><span class="s2">British Shorthair</span><span class="dl">"</span> <span class="p">},</span>
<span class="p">};</span>
 
<span class="nx">cats</span><span class="p">.</span><span class="nx">boris</span><span class="p">;</span> <span class="c1">// Here, the 'cats' is 'Record&lt;CatName, CatInfo&gt;'</span>
</code></pre></div></div> <h3 id="when-you-need-an-object-which-can-be-assigned-new-properties-you-can-use-record-utility-to-define-the-object-type">When you need an object which can be assigned new properties, you can use Record utility to define the object type.</h3> <p>Do this in past:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">obj</span><span class="p">:</span> <span class="p">{[</span><span class="nx">k</span><span class="p">:</span> <span class="kr">string</span><span class="p">]:</span> <span class="kr">any</span><span class="p">}</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">value</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop2</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
</code></pre></div></div> <p>Now using <code class="language-plaintext highlighter-rouge">Record&lt;Keys, Type&gt;</code> is a better way.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">obj</span><span class="p">:</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">unknown</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">value</span><span class="dl">"</span><span class="p">;</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">prop2</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">Record&lt;Keys,Type&gt;</code> is a much cleaner alternative for key-value pairs where property-names are not known. Itâ€™s worth noting that <code class="language-plaintext highlighter-rouge">Record&lt;Keys,Type&gt;</code> is a named alias to <code class="language-plaintext highlighter-rouge">{[k: Keys]: Type}</code> where <code class="language-plaintext highlighter-rouge">Keys</code> and <code class="language-plaintext highlighter-rouge">Type</code> are generics.</p> <h2 id="pick">Pick</h2> <p><code class="language-plaintext highlighter-rouge">Pick&lt;Type, Keys&gt;</code></p> <p>Constructs a type by picking the set of properties Keys (string literal or union of string literals) from <code class="language-plaintext highlighter-rouge">Type</code>.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Todo</span> <span class="p">{</span>
  <span class="nl">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">description</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">completed</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kd">type</span> <span class="nx">TodoPreview</span> <span class="o">=</span> <span class="nb">Pick</span><span class="o">&lt;</span><span class="nx">Todo</span><span class="p">,</span> <span class="dl">"</span><span class="s2">title</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">completed</span><span class="dl">"</span><span class="o">&gt;</span><span class="p">;</span>
 
<span class="kd">const</span> <span class="nx">todo</span><span class="p">:</span> <span class="nx">TodoPreview</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">title</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Clean room</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">completed</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div> <h2 id="omit">Omit</h2> <p><code class="language-plaintext highlighter-rouge">Omit&lt;Type, Keys&gt;</code></p> <p>Constructs a type by picking all properties from <code class="language-plaintext highlighter-rouge">Type</code> and then removing <code class="language-plaintext highlighter-rouge">Keys</code> (string literal or union of string literals). The opposite of <code class="language-plaintext highlighter-rouge">Pick</code>.</p> <p>Classic usage is omiting the <code class="language-plaintext highlighter-rouge">id</code> property for a object type.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">User</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">name</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Guest</span> <span class="o">=</span> <span class="nb">Omit</span><span class="o">&lt;</span><span class="nx">User</span><span class="p">,</span> <span class="s2">`id`</span><span class="o">&gt;</span><span class="p">;</span> <span class="c1">// then, Guest type just contain name. </span>
</code></pre></div></div> <h2 id="returntype">ReturnType</h2> <p><code class="language-plaintext highlighter-rouge">ReturnType&lt;Type&gt;</code></p> <p>Constructs a type consisting of the return type of function Type.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">T0</span> <span class="o">=</span> <span class="nb">ReturnType</span><span class="o">&lt;</span><span class="p">()</span> <span class="o">=&gt;</span> <span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">// type T0 = string</span>

<span class="kd">function</span> <span class="nf">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">3</span> <span class="p">};</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">P</span> <span class="o">=</span> <span class="nb">ReturnType</span><span class="o">&lt;</span><span class="k">typeof</span> <span class="nx">f</span><span class="o">&gt;</span><span class="p">;</span>   
<span class="c1">// type P = {</span>
<span class="c1">//     x: number;</span>
<span class="c1">//     y: number;</span>
<span class="c1">// }</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="TypeScript"/><category term="TypeScript"/><summary type="html"><![CDATA[TypeScript provides several utility types to facilitate common type transformations. These utilities are available globally.]]></summary></entry><entry><title type="html">Joins and Subqueries in SQL</title><link href="https://benwzj.github.io/blog/2024/sql-joint-subquery/" rel="alternate" type="text/html" title="Joins and Subqueries in SQL"/><published>2024-11-21T00:00:00+00:00</published><updated>2024-11-21T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/sql-joint-subquery</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/sql-joint-subquery/"><![CDATA[<h2 id="understand-joins">Understand Joins</h2> <p>Joins clause in SQL used to combine records from two or more tables. These tables are linked through common fields, and a join operation fetches data based on specified conditions.</p> <p>Joins can be of various types. Hereâ€™s a brief overview:</p> <ul> <li>INNER JOIN: Returns only the rows that have matching values in both tables.</li> <li>OUTER JOIN: Returns all rows from both tables, including unmatched rows.</li> <li>LEFT(OUTER) JOIN: Returns all records from the left table, and the matched records from the right table</li> <li>RIGHT(OUTER) JOIN: Returns all records from the right table, and the matched records from the left table</li> <li>CROSS JOIN: Produces a Cartesian product of the two tables, resulting in a combination of all rows.</li> </ul> <p>This Figures do a good job on showing the difference:</p> <figure> <picture> <img src="/assets/img/sql-joins.webp" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <p>Joins are specified in the FROM clause of a query and can significantly enhance the efficiency of data retrieval. They are essential for fetching data from multiple tables based on relationships.</p> <p>Usually we just use INNER JOIN and LEFT(OUTER) JOIN.</p> <h3 id="the-inner-join-usually-can-be-written-without-join-keyword">The INNER JOIN usually can be written without JOIN keyword:</h3> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Orders</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span> <span class="n">Customers</span><span class="p">.</span><span class="n">CustomerName</span><span class="p">,</span> <span class="n">Orders</span><span class="p">.</span><span class="n">OrderDate</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Customers</span> <span class="k">ON</span> <span class="n">Orders</span><span class="p">.</span><span class="n">CustomerID</span><span class="o">=</span><span class="n">Customers</span><span class="p">.</span><span class="n">CustomerID</span><span class="p">;</span>
</code></pre></div></div> <p>same with:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Orders</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span> <span class="n">Customers</span><span class="p">.</span><span class="n">CustomerName</span><span class="p">,</span> <span class="n">Orders</span><span class="p">.</span><span class="n">OrderDate</span>
<span class="k">FROM</span> <span class="n">Orders</span><span class="p">,</span> <span class="n">Customers</span>
<span class="k">where</span> <span class="n">Orders</span><span class="p">.</span><span class="n">CustomerID</span><span class="o">=</span><span class="n">Customers</span><span class="p">.</span><span class="n">CustomerID</span><span class="p">;</span>
</code></pre></div></div> <h3 id="understand-full-join">Understand Full Join</h3> <p>Full join means list all rows in tow table, if the rows meet condition, then join them together. But some popular DB like MySQL does not support the FULL OUTER JOIN syntax.</p> <h3 id="what-is-self-join">What is self join</h3> <p>A self join is a regular join, but the table is joined with itself.</p> <p>The following SQL statement matches customers that are from the same city:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">A</span><span class="p">.</span><span class="n">CustomerName</span> <span class="k">AS</span> <span class="n">CustomerName1</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">CustomerName</span> <span class="k">AS</span> <span class="n">CustomerName2</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">City</span>
<span class="k">FROM</span> <span class="n">Customers</span> <span class="n">A</span><span class="p">,</span> <span class="n">Customers</span> <span class="n">B</span>
<span class="k">WHERE</span> <span class="n">A</span><span class="p">.</span><span class="n">CustomerID</span> <span class="o">&lt;&gt;</span> <span class="n">B</span><span class="p">.</span><span class="n">CustomerID</span>
<span class="k">AND</span> <span class="n">A</span><span class="p">.</span><span class="n">City</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">City</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">A</span><span class="p">.</span><span class="n">City</span><span class="p">;</span>
</code></pre></div></div> <h2 id="what-is-a-subquery">What is a Subquery</h2> <p>A Subquery, also known as an Inner query or Nested query, is a query nested within another SQL query. It is enclosed within the WHERE clause and serves various purposes, such as filtering rows, calculating values, or retrieving data conditionally. Subqueries can be used in conjunction with SELECT, INSERT, UPDATE, DELETE, or CREATE VIEW statements.</p> <h2 id="joins-vs-subqueries">JOINs vs Subqueries</h2> <p>Usually, Subqueries are the logically correct way to solve problems. Subqueries are more readable than JOINs. However, it always comes down to performance. Although optimisers are getting better, in most cases JOINs are faster than subqueries.</p> <p>Important factors:</p> <ul> <li>There are different DBMSs</li> <li>Size matters</li> <li>There are different forms of sub-queries</li> </ul> <p>Historically, explicit joins usually win, hence the established wisdom that joins are better, but optimisers are getting better all the time, and so I prefer to write queries first in a logically coherent way, and then restructure if performance constraints warrant this.</p> <h3 id="how-dbms-process-sql-query">How DBMS process SQL query</h3> <p>The journey of an SQL query starts with parsing and tokenization, where the query is broken down into individual elements such as keywords (e.g., SELECT, FROM, WHERE) and operators (e.g., =, &gt;, &lt;). Following this, the database management system (DBMS) analyzes the query to devise optimal execution plans for data retrieval. With the execution plan in place, the DBMS begins the process of data retrieval. If the query involves multiple tables, the DBMS performs join operations to combine the relevant data. Subsequently, filtering conditions specified in the WHERE clause are applied to assess each rowâ€™s eligibility based on user-defined criteria. Additionally, common aggregation functions like SUM, MIN, MAX, AVG are utilized to perform calculations on grouped data. Upon completion of these operations, the DBMS generates the final result set, culminating the query execution process.</p> <figure> <picture> <img src="/assets/img/sql-process.webp" class="img-fluid rounded z-depth-1" width="60%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <p>Join operations are seamlessly integrated within the query execution steps. However, when using a subquery, the process involves executing the entire inner query first. Afterward, the table generated from this query is utilized in the WHERE clause to execute the outer query. This fundamental difference underscores why joins are favored over subqueries, particularly when dealing with large volumes of data. Sometimes, though, subqueries are preferred over joins when dealing with smaller datasets or when the complexity of the data requires it, mainly because they offer easier readability.</p> <h2 id="references">References</h2> <ul> <li>w3schools: <a href="https://www.w3schools.com/sql/sql_join.asp">SQL Join Doc</a></li> <li>stackoverflow topic: <a href="https://stackoverflow.com/questions/2577174/join-vs-sub-query">join-vs-sub-query</a></li> </ul>]]></content><author><name></name></author><category term="Database"/><category term="SQL"/><category term="Database"/><summary type="html"><![CDATA[Understand Joins]]></summary></entry><entry><title type="html">Next.js Middleware</title><link href="https://benwzj.github.io/blog/2024/nextjs-middleware/" rel="alternate" type="text/html" title="Next.js Middleware"/><published>2024-10-31T00:00:00+00:00</published><updated>2024-10-31T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/nextjs-middleware</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/nextjs-middleware/"><![CDATA[<h2 id="overview">Overview</h2> <p>Next.js copy the middleware concept from Express.js.</p> <p>In Next.js, Middleware allows you to run code before a request is completed. It is based on the incoming request, you can modify the response by rewriting, redirecting, modifying the request or response headers, or responding directly.</p> <p>But the Next.js documents is not good enough.</p> <h3 id="important-points">Important Points</h3> <ul> <li>Middleware will affect every request, so need to handle it carefully.</li> <li>Middleware let you share and reuse logic that is repeatable for every request.</li> <li>Middleware runs before cached content and routes are matched.</li> <li>Middleware run for all request, Normally, you need to use <code class="language-plaintext highlighter-rouge">matcher</code> to filter â€œMiddlewareâ€ to run on specific paths.</li> <li>The Middleware file â€œ/middleware.tsâ€ must export a <code class="language-plaintext highlighter-rouge">middleware</code> or a <code class="language-plaintext highlighter-rouge">default</code> function.</li> </ul> <h3 id="what-middleware-can-do">What Middleware can do:</h3> <ul> <li>redirect the incoming request to a different URL</li> <li>rewrite the response</li> <li>Set request headers for API Routes, getServerSideProps, and rewrite destinations</li> <li>Set response cookies</li> <li>Set response headers</li> </ul> <h3 id="when-to-use-middleware">When to use Middleware:</h3> <ul> <li>Authentication and Authorization</li> <li>Server-Side Redirects</li> <li>Path Rewriting, For example: A/B testing, feature rollouts, or legacy paths</li> <li>Bot Detection</li> <li>Logging and Analytics</li> <li>Feature Flagging</li> </ul> <h3 id="matching-paths">Matching Paths</h3> <p>Middleware will be invoked for every route in your project. The following is the execution order:</p> <ol> <li>headers from next.config.js</li> <li>redirects from next.config.js</li> <li>Middleware (rewrites, redirects, etc.)</li> <li>beforeFiles (rewrites) from next.config.js</li> <li>Filesystem routes (public/, _next/static/, pages/, app/, etc.)</li> <li>afterFiles (rewrites) from next.config.js</li> <li>Dynamic Routes (/blog/[slug])</li> <li>fallback (rewrites) from next.config.js</li> </ol> <p>There are two ways to define which paths Middleware will run on:</p> <ol> <li>Custom matcher config</li> <li>Conditional statements</li> </ol> <h2 id="understand-middleware">Understand middleware</h2> <p>Middleware logic happen inside the request-response cycle.</p> <h3 id="what-is-the-middleware-logic">What is the Middleware logic</h3> <p>I believe it should be this at the first thought: Client (send Request) â€”-&gt; Middleware(It do something) â€”â€“&gt; Route page(handle the Request) Then: Route Page (rend back Response) â€”-&gt; Middleware (then do something) â€”&gt; Client (get Response)</p> <p>But after few days research, the logic maybe not like that. It may be like this: Client (send Request) â€”-&gt; Middleware(It do something) â€”â€“&gt; Route page(handle the Request) Then: Route Page (rend back Response) â€”-&gt; Client (get Response)</p> <p>It is easier for SW design.</p> <h3 id="export-middleware-function-in-middlewarets">export middleware function in middleware.ts</h3> <p>The Middleware â€œ/middlewareâ€ must export a <code class="language-plaintext highlighter-rouge">middleware</code> or a <code class="language-plaintext highlighter-rouge">default</code> function.</p> <p>Basic example:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>

<span class="c1">// This function can be marked `async` if using `await` inside</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/home</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// See "Matching Paths" below to learn more</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">matcher</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/about/:path*</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="what-do-the-returned-value-of-the-middleware-funciton-means">What do the returned value of the middleware funciton means?</h3> <p>What i get Till now is that:</p> <ul> <li>Return <code class="language-plaintext highlighter-rouge">Response</code> or <code class="language-plaintext highlighter-rouge">NextResponse</code> object, then it will response back to client directly.</li> <li>Return <code class="language-plaintext highlighter-rouge">NextResponse.next()</code> will pass the request to the next middleware or route.</li> <li>Return <code class="language-plaintext highlighter-rouge">NextResponse.redirect('/login')</code> will redirect to <code class="language-plaintext highlighter-rouge">/login</code>.</li> <li>How about no <code class="language-plaintext highlighter-rouge">return</code>?</li> </ul> <h3 id="understand-nextresponse">Understand NextResponse</h3> <h4 id="what-do-nextresponsenext-mean">What do NextResponse.next() mean?</h4> <ul> <li> <p>In Middleware, The <code class="language-plaintext highlighter-rouge">NextResponse.next()</code> method allows you to return early and continue routing. What do it mean? The next() method passes the request to the next middleware or route.</p> </li> <li> <p>In Middleware, The <code class="language-plaintext highlighter-rouge">NextResponse.next()</code> also allow you to forward headers when producing the response. Like this: ```ts import { NextResponse } from â€œnext/serverâ€; import type { NextRequest } from â€œnext/serverâ€;</p> </li> </ul> <p>export function middleware(request: NextRequest) { // Add a new header x-current-path which passes the path to downstream components const headers = new Headers(request.headers); headers.set(â€œx-current-pathâ€, request.nextUrl.pathname); return NextResponse.next({ headers }); }</p> <p>export const config = { matcher: [ // match all routes except static files and APIs â€œ/((?!api|_next/static|_next/image|favicon.ico).*)â€, ], };</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>we can look for the `x-current-path` header in server component:
```ts
import { headers } from "next/headers";
 
export default async function Sidebar() {
  const headerList = headers();
  const pathname = headerList.get("x-current-path");

  // ...etc
}
</code></pre></div></div> <p>How this happen underneath? Why server component can get header information which set by <code class="language-plaintext highlighter-rouge">NextResponse.next</code>?</p> <h2 id="use-middleware-in-nextjs">Use Middleware in Next.js</h2> <ul> <li>Use the file <code class="language-plaintext highlighter-rouge">middleware.ts</code> (or .js) in the <strong>root</strong> of your project to define Middleware.</li> <li>Only one <code class="language-plaintext highlighter-rouge">middleware.ts</code> file is supported per project</li> <li>Because Middleware will be invoked for every route in your project, so you should use <code class="language-plaintext highlighter-rouge">matchers</code> to precisely target or exclude specific routes. Or using Conditional Statements in <code class="language-plaintext highlighter-rouge">middleware.ts</code>.</li> </ul> <h3 id="redirect">redirect</h3> <ul> <li><code class="language-plaintext highlighter-rouge">redirect</code> the incoming request to a different URL.</li> <li><code class="language-plaintext highlighter-rouge">rewrite</code> the response by displaying a given URL. The difference between <code class="language-plaintext highlighter-rouge">redirect</code> and <code class="language-plaintext highlighter-rouge">rewrite</code> is that , <code class="language-plaintext highlighter-rouge">rewrite</code> donâ€™t show the handleing URL to user. ```ts //middleware.ts import { NextResponse } from â€˜next/serverâ€™; import type { NextRequest } from â€˜next/serverâ€™;</li> </ul> <p>export function authenticationMiddleware(request: NextRequest) { // Check if the user is authenticated if (!request.headers.cookie?.includes(â€˜authenticated=trueâ€™)) { return NextResponse.redirect(â€˜/loginâ€™); } return NextResponse.next(); // Continue to the next Middleware or route handler }</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Response to Client directly
Middleware can produce responses directly by returning a Response or NextResponse instance.
```ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function customResponseMiddleware(request: NextRequest) {
  if (/* Some condition */) {
    return new Response('Custom error message', { status: 400 }); // response to Client directly
  }
  return NextResponse.next(); // pass to the next Middleware or Route handler. 
}
</code></pre></div></div> <h3 id="add-header-and-cookie">Add header and cookie</h3> <p>Middleware can manipulate headers and cookies in both incoming requests and outgoing responses. This is useful for tasks like customizing the response or managing user sessions.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">customHeadersMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">x-current-path</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">);</span> 
  <span class="nx">response</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Middleware-Set-Cookie</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="modifying-request-headers">Modifying Request Headers</h3> <p>You can use Middleware to modify the headers of outgoing API requests. This is often done to add authentication tokens, API keys, or other necessary information to the headers before sending the request.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">apiInterceptorMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Modify the API request headers</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Bearer myAccessToken</span><span class="dl">'</span><span class="p">);</span>

  <span class="c1">// Cache API responses for improved performance</span>
  <span class="c1">// Implement caching logic here</span>

  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="caching-api-responses">Caching API Responses</h3> <p>To improve the performance of your application, you can implement caching of API responses within Middleware. This helps reduce the load on external APIs and speeds up subsequent requests for the same data.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">apiInterceptorMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check if the response is already cached</span>
  <span class="kd">const</span> <span class="nx">cachedResponse</span> <span class="o">=</span> <span class="cm">/* Implement caching logic here */</span><span class="p">;</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">cachedResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If cached, return the cached response</span>
    <span class="k">return</span> <span class="nx">cachedResponse</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// If not cached, make the API request and cache the response</span>
    <span class="kd">const</span> <span class="nx">apiResponse</span> <span class="o">=</span> <span class="cm">/* Make the API request */</span><span class="p">;</span>

    <span class="c1">// Cache the response for future use</span>
    <span class="cm">/* Cache the response */</span>

    <span class="k">return</span> <span class="nx">apiResponse</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="mocking-api-calls-for-testing">Mocking API Calls for Testing</h3> <p>Middleware can also be used to mock API calls during testing. This ensures that your tests are not dependent on external services, making them more reliable and faster.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">apiMockMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// In a testing environment, return a mocked response</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Response</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span> <span class="na">mockData</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}),</span> <span class="p">{</span>
      <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// In other environments, continue to the next Middleware or route handler</span>
    <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="waituntil-and-nextfetchevent"><code class="language-plaintext highlighter-rouge">waitUntil</code> and <code class="language-plaintext highlighter-rouge">NextFetchEvent</code></h3> <p>The <code class="language-plaintext highlighter-rouge">NextFetchEvent</code> object extends the native <code class="language-plaintext highlighter-rouge">FetchEvent</code> object, and includes the <code class="language-plaintext highlighter-rouge">waitUntil()</code> method. The <code class="language-plaintext highlighter-rouge">waitUntil()</code> method takes a promise as an argument, and extends the lifetime of the Middleware until the promise settles. This is useful for performing work in the background.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// middleware.ts</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextFetchEvent</span><span class="p">,</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">function</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">,</span> <span class="nx">event</span><span class="p">:</span> <span class="nx">NextFetchEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nf">waitUntil</span><span class="p">(</span>
    <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://my-analytics-platform.com</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span> <span class="na">pathname</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span> <span class="p">}),</span>
    <span class="p">})</span>
  <span class="p">)</span>
 
  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="faq">FAQ</h2> <h3 id="middleware-and-useformstate">middleware and useFormState?</h3> <p>When I add following code in middleware.ts, then <code class="language-plaintext highlighter-rouge">useFormState</code> wonâ€™t work propertly: the return <code class="language-plaintext highlighter-rouge">state</code> always be <code class="language-plaintext highlighter-rouge">undefined</code> which should be the returned value of the actionFn. Why?</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Add a new header x-current-path which passes the path to downstream components</span>
  <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Headers</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  <span class="nx">headers</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">x-current-path</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">({</span> <span class="nx">headers</span> <span class="p">});</span>
</code></pre></div></div>]]></content><author><name></name></author><category term="Next.js"/><category term="React"/><category term="TypeScript"/><category term="Next.js"/><summary type="html"><![CDATA[Overview]]></summary></entry><entry><title type="html">Next.js Caching introduction</title><link href="https://benwzj.github.io/blog/2024/nextjs-cache/" rel="alternate" type="text/html" title="Next.js Caching introduction"/><published>2024-10-22T00:00:00+00:00</published><updated>2024-10-22T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/nextjs-cache</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/nextjs-cache/"><![CDATA[<h2 id="caching-overview">Caching Overview</h2> <p>Next.js is a framework, it provide the whole cache solusion. It use React Cache machinisum, also it provide it own machinisum. Basically it can be divided into 4 categories: There are 4 different caching mechanisms:</p> <ul> <li>Request Memoization: based on React extand <code class="language-plaintext highlighter-rouge">fetch</code> function</li> <li>Data Cache: based on Next.js extand <code class="language-plaintext highlighter-rouge">fetch</code> function</li> <li>Full Route Cache: Next.js prepare this at <strong>Build-Time</strong>, at Sever-side</li> <li>Client-side Router Cache: Next.js caches the visited route segments and prefetches the routes the user is likely to navigate to at Client side. Simply say using <code class="language-plaintext highlighter-rouge">&lt;link/&gt;</code></li> </ul> <h2 id="some-concepts">Some Concepts</h2> <ul> <li><code class="language-plaintext highlighter-rouge">fetch</code> API</li> <li>React cache</li> <li>Next.js <code class="language-plaintext highlighter-rouge">unstable_cache</code></li> <li>Server Rendering Strategies <ul> <li><strong>Static Rendering (Default)</strong>: With Static Rendering, routes are rendered at build time, or in the background after data revalidation. The result is cached and can be pushed to a Content Delivery Network (CDN).</li> <li><strong>Dynamic Rendering</strong>: With Dynamic Rendering, routes are rendered for each user at request time. During rendering, if a <em>Dynamic API</em> or <em>uncached data</em> request is discovered, Next.js will <em>switch</em> to dynamically rendering the whole route.</li> <li><strong>Streaming</strong>: Streaming enables you to progressively render UI from the server. Work is split into chunks and streamed to the client as it becomes ready. This allows the user to see parts of the page immediately, before the entire content has finished rendering.</li> <li>As a developer, you do not need to choose between static and dynamic rendering as Next.js will automatically choose the best rendering strategy for each route based on the features and APIs used. Instead, you choose when to <strong>cache</strong> or <strong>revalidate</strong> specific data, and you may choose to stream parts of your UI.</li> <li>Dynamic APIs: like <code class="language-plaintext highlighter-rouge">cookies</code>, <code class="language-plaintext highlighter-rouge">headers</code>, or reading the incoming <code class="language-plaintext highlighter-rouge">searchParams</code> from the page props etc. which will automatically make the page render dynamically.</li> </ul> </li> <li>RSC Payload and data are cached separately.</li> </ul> <h2 id="nextjs-caching-foundation">Next.js Caching Foundation</h2> <p>If you use <code class="language-plaintext highlighter-rouge">next dev</code> to run the application. it wonâ€™t cache the response. But when you run a production build by using <code class="language-plaintext highlighter-rouge">next build</code>, even for the server components, they will be revaluated during the build, and they will be set to be prerendered by default. (The same thing is applied for route handler.)</p> <p>It can switch to Dynamic Rendering if a <code class="language-plaintext highlighter-rouge">Dynamic API</code> or <code class="language-plaintext highlighter-rouge">uncached data</code> request is discovered.</p> <p>APIs and data caching affect whether a route is statically or dynamically rendered:</p> <figure> <picture> <img src="/assets/img/sever-rendering-switch.png" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h2 id="example-of-using-caching-when-fetching">Example of Using Caching when fetching</h2> <h3 id="fetching-data-on-the-server-with-the-fetch-api">Fetching data on the server with the fetch API</h3> <p>If you are using <code class="language-plaintext highlighter-rouge">fetch</code>, <code class="language-plaintext highlighter-rouge">requests</code> are automatically memoized. This means you can safely call the same URL with the same options, and only one <code class="language-plaintext highlighter-rouge">request</code> will be made. The response from fetch will be automatically cached: <code class="language-plaintext highlighter-rouge">let data = await fetch('https://api.example.app/blog')</code> If you do not want to cache the response from fetch, you can do the following: <code class="language-plaintext highlighter-rouge">let data = await fetch('https://api.example.app/blog', { cache: 'no-store' })</code></p> <h3 id="caching-data-with-an-orm-or-database">Caching data with an ORM or Database</h3> <p>You can use the <code class="language-plaintext highlighter-rouge">unstable_cache</code> API to cache the response to allow pages to be prerendered when running <code class="language-plaintext highlighter-rouge">next build</code>.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">unstable_cache</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/cache</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">db</span><span class="p">,</span> <span class="nx">posts</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/lib/db</span><span class="dl">'</span>
 
<span class="kd">const</span> <span class="nx">getPosts</span> <span class="o">=</span> <span class="nf">unstable_cache</span><span class="p">(</span>
  <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">await</span> <span class="nx">db</span><span class="p">.</span><span class="nf">select</span><span class="p">().</span><span class="k">from</span><span class="p">(</span><span class="nx">posts</span><span class="p">)</span>
  <span class="p">},</span>
  <span class="p">[</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">],</span>
  <span class="p">{</span> <span class="na">revalidate</span><span class="p">:</span> <span class="mi">3600</span><span class="p">,</span> <span class="na">tags</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">]</span> <span class="p">}</span>
<span class="p">)</span>
 
<span class="k">export</span> <span class="k">default</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">Page</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">allPosts</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getPosts</span><span class="p">()</span>
 
  <span class="k">return </span><span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
      <span class="p">{</span><span class="nx">allPosts</span><span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">post</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="nx">li</span> <span class="nx">key</span><span class="o">=</span><span class="p">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">post</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>      <span class="p">))}</span>
    <span class="o">&lt;</span><span class="sr">/ul</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>This example caches the result of the database query for 1 hour (3600 seconds). It also adds the cache tag posts which can then be invalidated with Incremental Static Regeneration.</p> <h2 id="in-depth-look">In-depth Look</h2> <p>There are 4 different caching mechanisms:</p> <ul> <li>Request Memoization</li> <li>Data Cache</li> <li>Full Route Cache</li> <li>Client-side Router Cache</li> </ul> <p>And they will interact with each other.</p> <p>Hereâ€™s a high-level overview:</p> <figure> <picture> <img src="/assets/img/caching-overview.png" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <blockquote> <p>By default, Next.js will cache as much as possible to improve performance and reduce cost. This means routes are statically rendered and data requests are cached unless you opt out.</p> </blockquote> <h3 id="request-memoization">Request Memoization</h3> <p>This is a React feature, not a Next.js feature. React extends the <code class="language-plaintext highlighter-rouge">fetch</code> API to automatically memoize requests that have the same URL and options. This means you can call a fetch function for the same data in multiple places in a React component tree while only executing it once.</p> <p>The memoization is not shared across server requests and only applies during rendering, there is no need to revalidate it.</p> <h3 id="data-cache">Data Cache</h3> <p>Next.js has a built-in Data Cache that persists the result of data fetches across incoming server requests and deployments. This is possible because Next.js extends the native <code class="language-plaintext highlighter-rouge">fetch</code> API to allow each request on the <strong>server</strong> to set its own persistent caching semantics.</p> <blockquote> <p>Good to know: In the browser, the <code class="language-plaintext highlighter-rouge">cache</code> option of <code class="language-plaintext highlighter-rouge">fetch</code> indicates how a request will interact with the browserâ€™s HTTP cache, in Next.js, the <code class="language-plaintext highlighter-rouge">cache</code> option indicates how a server-side request will interact with the serverâ€™s Data Cache.</p> </blockquote> <p>The Data Cache is persistent across incoming requests and deployments unless you revalidate or opt-out.</p> <ul> <li>revalidate: <ul> <li>Time-based Revalidation: <code class="language-plaintext highlighter-rouge">fetch('https://api.example.app/blog', { next: { revalidate: 3600 } })</code></li> <li>On-demand Revalidation: Data can be revalidated on-demand by path (<code class="language-plaintext highlighter-rouge">revalidatePath</code>) or by cache tag (<code class="language-plaintext highlighter-rouge">revalidateTag</code>).</li> </ul> </li> <li>opt-out: using <code class="language-plaintext highlighter-rouge">let data = await fetch('https://api.example.app/blog', { cache: 'no-store' })</code>.</li> </ul> <h4 id="other-than-fetch">Other than fetch</h4> <p>If you are fetch data at server side or using 3rd party lib, you can use <code class="language-plaintext highlighter-rouge">unstable_cache</code> function.</p> <h4 id="differences-between-the-data-cache-and-request-memoization">Differences between the Data Cache and Request Memoization</h4> <p>While both caching mechanisms help improve performance by re-using cached data, the Data Cache is persistent across incoming requests and deployments, whereas memoization only lasts the lifetime of a request.</p> <h3 id="full-route-cache">Full Route Cache</h3> <p>Next.js automatically renders and caches routes at <strong>build time</strong>. This is an optimization that allows you to serve the cached route instead of rendering on the server for every request, resulting in faster page loads.</p> <h4 id="how-the-full-route-cache-works">How the Full Route Cache works</h4> <p>To understand how the Full Route Cache works, itâ€™s helpful to look at how React handles rendering, and how Next.js caches the result.</p> <ol> <li>React Rendering on the Server: The rendering work is split into chunks: by individual routes segments and Suspense boundaries.</li> <li>Next.js Caching on the Server (Full Route Cache): The default behavior of Next.js is to cache the rendered result (React Server Component Payload and HTML) of a route on the server. This applies to statically rendered routes at build time, or during revalidation.</li> <li>React Hydration and Reconciliation on the Client: At request time, on the client: <ul> <li>The HTML is used to <strong>immediately show</strong> a fast non-interactive initial preview of the Client and Server Components.</li> <li>The RSC Payload is used to <strong>reconcile</strong> the Client and rendered Server Component trees, and update the DOM.</li> <li>The JavaScript instructions are used to <strong>hydrate</strong> Client Components and make the application interactive.</li> </ul> </li> <li>Next.js Caching on the Client (Router Cache): This Router Cache is used to improve the navigation experience by storing previously visited routes and prefetching future routes.</li> <li>Subsequent Navigations: On subsequent navigations or during prefetching, Next.js will check if the React Server Components Payload is stored in the Router Cache. If so, it will skip sending a new request to the server.</li> </ol> <h4 id="static-and-dynamic-rendering">Static and Dynamic Rendering</h4> <p>This diagram shows the difference between statically and dynamically rendered routes, with cached and uncached data:</p> <figure> <picture> <img src="/assets/img/static-and-dynamic-routes.avif" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="client-side-router-cache">Client-side Router Cache</h3> <p>Next.js has an in-memory client-side router cache that stores the RSC payload of route segments, split by layouts, loading states, and pages.</p> <p>When a user navigates between routes, Next.js caches the visited route segments and prefetches the routes the user is likely to navigate to. This results in instant back/forward navigation, no full-page reload between navigations, and preservation of React state and browser state.</p> <h4 id="duration-and-invalidation">Duration and Invalidation</h4> <p>The cache is stored in the browserâ€™s temporary memory. While a page refresh will clear all cached segments.</p> <p>There are two ways you can invalidate the Router Cache:</p> <ul> <li>In a Server Action: <ul> <li>Revalidating data on-demand by path with (<code class="language-plaintext highlighter-rouge">revalidatePath</code>) or by cache tag with (<code class="language-plaintext highlighter-rouge">revalidateTag</code>)</li> <li>Using <code class="language-plaintext highlighter-rouge">cookies.set</code> or <code class="language-plaintext highlighter-rouge">cookies.delete</code> invalidates the Router Cache to prevent routes that use cookies from becoming stale (e.g. authentication).</li> </ul> </li> <li>Calling <code class="language-plaintext highlighter-rouge">router.refresh</code> will invalidate the Router Cache and make a new request to the server for the current route.</li> </ul> <h2 id="nextjs-apis-affect-caching">Next.js APIs affect caching</h2> <h3 id="link"><code class="language-plaintext highlighter-rouge">&lt;Link&gt;</code></h3> <p>By default, the <code class="language-plaintext highlighter-rouge">&lt;Link&gt;</code> component automatically prefetches routes from the Full Route Cache and adds the React Server Component Payload to the Router Cache.</p> <h3 id="routerprefetch"><code class="language-plaintext highlighter-rouge">router.prefetch</code></h3> <p>The prefetch option of the useRouter hook can be used to manually prefetch a route. This adds the React Server Component Payload to the Router Cache.</p> <h3 id="routerrefresh"><code class="language-plaintext highlighter-rouge">router.refresh</code></h3> <p>The refresh option of the useRouter hook can be used to manually refresh a route.</p> <h3 id="fetch"><code class="language-plaintext highlighter-rouge">fetch</code></h3> <p>Data returned from fetch is automatically cached in the Data Cache.</p> <h3 id="fetch-optionscache"><code class="language-plaintext highlighter-rouge">fetch options.cache</code></h3> <p>You can opt individual fetch into caching by setting the cache option to force-cache</p> <h3 id="fetch-optionsnextrevalidate"><code class="language-plaintext highlighter-rouge">fetch options.next.revalidate</code></h3> <p>You can use the next.revalidate option of fetch to set the revalidation period (in seconds) of an individual fetch request. This will revalidate the Data Cache, which in turn will revalidate the Full Route Cache. Fresh data will be fetched, and components will be re-rendered on the server.</p> <h3 id="fetch-optionsnexttags-and-revalidatetag"><code class="language-plaintext highlighter-rouge">fetch options.next.tags and revalidateTag</code></h3> <p>Next.js has a cache tagging system for fine-grained data caching and revalidation.</p> <h3 id="revalidatepath"><code class="language-plaintext highlighter-rouge">revalidatePath</code></h3> <p>revalidatePath allows you manually revalidate data and re-render the route segments below a specific path in a single operation. Calling the revalidatePath method revalidates the Data Cache, which in turn invalidates the Full Route Cache.</p> <h3 id="dynamic-apis">Dynamic APIs</h3> <p>Dynamic APIs like <code class="language-plaintext highlighter-rouge">cookies</code> and <code class="language-plaintext highlighter-rouge">headers</code>, and the <code class="language-plaintext highlighter-rouge">searchParams</code> prop in Pages depend on runtime incoming request information. Using them will opt a route out of the Full Route Cache, in other words, the route will be dynamically rendered.</p> <h3 id="segment-config-options">Segment Config Options</h3> <p>The Route Segment Config options can be used to override the route segment defaults or when youâ€™re not able to use the fetch API (e.g. database client or 3rd party libraries).</p> <h3 id="generatestaticparams"><code class="language-plaintext highlighter-rouge">generateStaticParams</code></h3> <p>For dynamic segments (e.g. app/blog/[slug]/page.js), paths provided by generateStaticParams are cached in the Full Route Cache at build time. At request time, Next.js will also cache paths that werenâ€™t known at build time the first time theyâ€™re visited.</p> <h3 id="react-cache-function">React <code class="language-plaintext highlighter-rouge">cache</code> function</h3> <p>The React <code class="language-plaintext highlighter-rouge">cache</code> function allows you to memoize the return value of a function on the server, allowing you to call the same function multiple times while only executing it once.</p> <h2 id="references">References</h2> <ul> <li><a href="https://nextjs.org/docs/app/building-your-application/caching">next.js doc for caching</a></li> </ul>]]></content><author><name></name></author><category term="Next.js"/><category term="Next.js"/><category term="React"/><category term="Router"/><summary type="html"><![CDATA[Caching Overview]]></summary></entry><entry><title type="html">Handle Error in JavaScript</title><link href="https://benwzj.github.io/blog/2024/error-js/" rel="alternate" type="text/html" title="Handle Error in JavaScript"/><published>2024-09-19T00:00:00+00:00</published><updated>2024-09-19T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/error-js</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/error-js/"><![CDATA[<p>Using <code class="language-plaintext highlighter-rouge">Error</code>, <code class="language-plaintext highlighter-rouge">try/catch</code>, <code class="language-plaintext highlighter-rouge">throw</code> to make code easier to debug. They can also make the code structure clearer.</p> <h2 id="error-overview">Error Overview</h2> <p>Here are some conclusions:</p> <ul> <li><code class="language-plaintext highlighter-rouge">Error</code> is Standard built-in objects.</li> <li><code class="language-plaintext highlighter-rouge">Error</code> objects are thrown when runtime errors occur.</li> <li>Usually you create an <code class="language-plaintext highlighter-rouge">Error</code> object with the intention of raising it using the <code class="language-plaintext highlighter-rouge">throw</code> keyword. You can handle the error using the <code class="language-plaintext highlighter-rouge">try...catch</code> construct.</li> <li>Error types: Besides the <strong>generic <code class="language-plaintext highlighter-rouge">Error</code> constructor</strong>, there are still: EvalError, TypeError, etc. in JavaScript.</li> <li>The <code class="language-plaintext highlighter-rouge">Error</code> object can also be used as a base object for user-defined exceptions.</li> </ul> <blockquote> <p>A cleaner and more consistent error handling way is that define your own error types deriving from <code class="language-plaintext highlighter-rouge">Error</code> to be able to throw new <code class="language-plaintext highlighter-rouge">MyError()</code> and use <code class="language-plaintext highlighter-rouge">instanceof MyError</code> to check the kind of error in the exception handler. This results in cleaner and more consistent error handling code.</p> </blockquote> <h2 id="error-instance">Error Instance</h2> <h3 id="errorprototypeconstructor">Error.prototype.constructor</h3> <p>syntax: <code class="language-plaintext highlighter-rouge">new Error(message, options)</code> JavaScript only tries to read <code class="language-plaintext highlighter-rouge">options.cause</code> if <code class="language-plaintext highlighter-rouge">options</code> is an object.</p> <blockquote> <p>Note: Error() can be called with or without new. Both create a new Error instance.</p> </blockquote> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">x</span> <span class="o">=</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">I was created using a function call!</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// above has the same functionality as following</span>
<span class="kd">const</span> <span class="nx">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">I was constructed via the "new" keyword!</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div> <h3 id="errorprototypename">Error.prototype.name</h3> <p>The <code class="language-plaintext highlighter-rouge">name</code> data property of <code class="language-plaintext highlighter-rouge">Error.prototype</code> is shared by all Error instances. It represents the name for the type of error.</p> <h3 id="errorcause">Error.cause</h3> <p>The <code class="language-plaintext highlighter-rouge">cause</code> data property of an Error instance indicates the specific original cause of the error.</p> <p>It is used when catching and re-throwing an error with a more-specific or useful error message in order to still have access to the original error.</p> <p>The value of cause can be of any type.</p> <h3 id="error-message">Error: message</h3> <p>The <code class="language-plaintext highlighter-rouge">message</code> data property of an Error instance is a human-readable description of the error.</p> <p>The <code class="language-plaintext highlighter-rouge">message</code> property combined with the <code class="language-plaintext highlighter-rouge">name</code> property is used by the <code class="language-plaintext highlighter-rouge">Error.prototype.toString()</code> method to create a string representation of the Error.</p> <h3 id="errorprototypestack">Error.prototype.stack</h3> <p>This feature is non-standard, but it is de facto implemented by all major JavaScript engines, and the JavaScript standards committee is looking to standardize it.</p> <ul> <li>The value of <code class="language-plaintext highlighter-rouge">stack</code> is <strong>string</strong>.</li> <li>you can assume it exists and use it for <strong>debugging</strong> purposes.</li> <li>The <code class="language-plaintext highlighter-rouge">stack</code> property of an Error instance offers a trace of which functions were called, in what order, from which line and file, and with what arguments.</li> <li>The stack string proceeds from the most recent calls to earlier ones, leading back to the original global scope call.</li> <li>Each JavaScript engine uses its own format for stack traces, but they are fairly consistent in their high-level structure.</li> </ul> <p>Example:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">trace</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">trace() failed</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">b</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">trace</span><span class="p">();</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nf">a</span><span class="p">()</span> <span class="p">{</span>
  <span class="nf">b</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="dl">"</span><span class="se">\n\n</span><span class="dl">"</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="nf">a</span><span class="p">(</span><span class="dl">"</span><span class="s2">first call, firstarg</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">output</span><span class="dl">"</span><span class="p">).</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>then you can see in <code class="language-plaintext highlighter-rouge">output</code> element:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Error: trace() failed
    at trace (&lt;anonymous&gt;:2:9)
    at b (&lt;anonymous&gt;:5:3)
    at a (&lt;anonymous&gt;:8:3)
    at &lt;anonymous&gt;:11:3
    at init (https://live.mdnplay.dev/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/stack/runner.html?id=using_the_stack_property:133:23)
    at https://live.mdnplay.dev/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/stack/runner.html?id=using_the_stack_property:146:17
</code></pre></div></div> <h2 id="how-to-differentiate-between-similar-errors">How to Differentiate between similar errors</h2> <p>Sometimes a block of code can fail for reasons that require different handling, but which throw very similar errors (i.e. with the same type and message).</p> <p>If you donâ€™t have control over the original errors that are thrown, one option is to catch them and throw new Error objects that have more specific messages.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">doWork</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nf">doFailSomeWay</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed in some way</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">cause</span><span class="p">:</span> <span class="nx">err</span> <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nf">doFailAnotherWay</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed in another way</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">cause</span><span class="p">:</span> <span class="nx">err</span> <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nf">doWork</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch </span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">Failed in some way</span><span class="dl">"</span><span class="p">:</span>
      <span class="nf">handleFailSomeWay</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">cause</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="dl">"</span><span class="s2">Failed in another way</span><span class="dl">"</span><span class="p">:</span>
      <span class="nf">handleFailAnotherWay</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">cause</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="a-good-way-to-extend-error">A good way to extend Error</h2> <p>Read more at <a href="https://stackoverflow.com/questions/1382107/whats-a-good-way-to-extend-error-in-javascript">stackoverflow</a>.</p> <p>Best way is using class and extend. But you can still use function.</p> <h3 id="use-class">Use class</h3> <p>Use <code class="language-plaintext highlighter-rouge">class</code> and <code class="language-plaintext highlighter-rouge">extend</code> keywords to subclass Error constructor:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyError</span> <span class="kd">extends</span> <span class="nc">Error</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">MyError</span><span class="dl">'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>There is no need for <code class="language-plaintext highlighter-rouge">this.stack = (new Error()).stack;</code> trick thanks to <code class="language-plaintext highlighter-rouge">super()</code> call.</p> <p>For ease of maintaining, use <code class="language-plaintext highlighter-rouge">this.name = this.constructor.name;</code> instead. Try this:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyError</span> <span class="kd">extends</span> <span class="nc">Error</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
    <span class="c1">//this.name = 'MyError';</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="kd">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="use-function">Use function</h3> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">MyError</span> <span class="p">(</span><span class="nx">message</span><span class="p">){</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">MyError</span><span class="dl">'</span><span class="p">;</span>
  <span class="nb">Error</span><span class="p">.</span><span class="nf">captureStackTrace</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// does the same magic as extends keyword</span>
<span class="nb">Object</span><span class="p">.</span><span class="nf">setPrototypeOf</span><span class="p">(</span><span class="nx">MyError</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nb">Error</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</code></pre></div></div> <h3 id="test-result">Test result</h3> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nc">MyError</span><span class="p">(</span><span class="dl">'</span><span class="s1">this is test</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
  <span class="c1">// true</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// true</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">MyError</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="throw">throw</h2> <p>The <code class="language-plaintext highlighter-rouge">throw</code> statement throws a user-defined exception. Execution of the current function will stop (the statements after throw wonâ€™t be executed), and control will be passed to the <strong>first</strong> <code class="language-plaintext highlighter-rouge">catch</code> block in the call stack. If no <code class="language-plaintext highlighter-rouge">catch</code> block exists among caller functions, the program will terminate.</p> <p>Usually, <code class="language-plaintext highlighter-rouge">throw</code> statement throw an Error instance:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">getRectArea</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nf">isNaN</span><span class="p">(</span><span class="nx">width</span><span class="p">)</span> <span class="o">||</span> <span class="nf">isNaN</span><span class="p">(</span><span class="nx">height</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Parameter is not a number!</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nf">getRectArea</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="c1">// Expected output: Error: Parameter is not a number!</span>
<span class="p">}</span>
</code></pre></div></div> <p>But it can throw any object. and <code class="language-plaintext highlighter-rouge">catch</code> statement can catch that object.</p> <h2 id="trycatch">tryâ€¦catch</h2> <p>The <code class="language-plaintext highlighter-rouge">try...catch</code> statement is comprised of a <code class="language-plaintext highlighter-rouge">try</code> block and either a <code class="language-plaintext highlighter-rouge">catch</code> block, a <code class="language-plaintext highlighter-rouge">finally</code> block, or both. The code in the try block is executed first, and if it throws an exception, the code in the <code class="language-plaintext highlighter-rouge">catch</code> block will be executed. The code in the <code class="language-plaintext highlighter-rouge">finally</code> block will always be executed before control flow exits the entire construct.</p> <p>A common use case for this is to only catch (and silence) a small subset of expected errors, and then re-throw the error in other cases:</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="p">{</span>
  <span class="nf">myRoutine</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">RangeError</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// statements to handle this very common expected error</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="nx">e</span><span class="p">;</span> <span class="c1">// re-throw the error unchanged</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="execute-order-in-nested-try-blocks">Execute order in Nested try blocks</h3> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">oops</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">finally</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">outer</span><span class="dl">"</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Logs:</span>
<span class="c1">// "finally"</span>
<span class="c1">// "outer" "oops"</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">oops</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">inner</span><span class="dl">"</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">finally</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">outer</span><span class="dl">"</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Logs:</span>
<span class="c1">// "inner" "oops"</span>
<span class="c1">// "finally"</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">oops</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">inner</span><span class="dl">"</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">finally</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">outer</span><span class="dl">"</span><span class="p">,</span> <span class="nx">ex</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// Logs:</span>
<span class="c1">// "inner" "oops"</span>
<span class="c1">// "finally"</span>
<span class="c1">// "outer" "oops"</span>
</code></pre></div></div> <h2 id="faq">FAQ</h2> <ul> <li>what is <code class="language-plaintext highlighter-rouge">stack</code> proerpty.</li> </ul>]]></content><author><name></name></author><category term="JavaScript"/><category term="JavaScript"/><summary type="html"><![CDATA[Using Error, try/catch, throw to make code easier to debug. They can also make the code structure clearer.]]></summary></entry><entry><title type="html">Vite Overview</title><link href="https://benwzj.github.io/blog/2024/vite/" rel="alternate" type="text/html" title="Vite Overview"/><published>2024-08-13T00:00:00+00:00</published><updated>2024-08-13T00:00:00+00:00</updated><id>https://benwzj.github.io/blog/2024/vite</id><content type="html" xml:base="https://benwzj.github.io/blog/2024/vite/"><![CDATA[<p>There are many blogs which compare Vite and Webpack. But Vite is just a front web application tool which is similar to Create-React-App. Vite is using esbuild and Rollup to bundle resource while CRA is using webpack.</p> <h2 id="why-vite">Why Vite</h2> <p>Before ES modules were available in browsers, developers had no native mechanism for authoring JavaScript in a modularized fashion. This is why we are all familiar with the <strong>concept of â€œbundlingâ€</strong>: using tools that crawl, process and concatenate our source modules into files that can run in the browser.</p> <p>Over time we have seen tools like webpack, Rollup and Parcel, which greatly improved the development experience for frontend developers.</p> <p>Main problems:</p> <ul> <li> <p>Slow Server Start: When cold-starting the dev server, a bundler-based build setup has to eagerly crawl and build your entire application before it can be served.</p> </li> <li> <p>Slow Updates: When a file is edited in a bundler-based build setup, it is inefficient to rebuild the whole bundle for an obvious reason: the update speed will degrade linearly with the size of the app.</p> </li> </ul> <h2 id="what-vite-provide">What Vite provide</h2> <h3 id="improve-slow-server-start">Improve Slow Server Start</h3> <p>Vite improves the dev server start time by first dividing the modules in an application into two categories: dependencies and source code.</p> <ul> <li> <p><strong>Dependencies</strong> are mostly plain JavaScript that do not change often during development. Vite pre-bundles dependencies using esbuild.</p> </li> <li> <p><strong>Source code</strong> often contains non-plain JavaScript that needs transforming (e.g. JSX, CSS or Vue/Svelte components), and will be edited very often. Also, not all source code needs to be loaded at the same time (e.g. with route-based code-splitting). Vite serves source code over native ESM. This is essentially letting the browser take over part of the job of a bundler: Vite only needs to transform and serve source code on demand, as the browser requests it.</p> </li> </ul> <figure> <picture> <img src="/assets/img/Bundle-based.png" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figure> <picture> <img src="/assets/img/es-mould.png" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h3 id="improve-slow-updates">Improve Slow Updates</h3> <p>When a file is edited in a bundler-based build setup, it is inefficient to rebuild the whole bundle for an obvious reason: the update speed will degrade linearly with the size of the app.</p> <blockquote> <p>Hot Module Replacement (HMR): allowing a module to â€œhot replaceâ€ itself without affecting the rest of the page.</p> </blockquote> <p>In Vite, HMR is performed over native ESM. When a file is edited, Vite only needs to precisely invalidate the chain between the edited module and its closest HMR boundary (most of the time only the module itself), making HMR updates consistently fast regardless of the size of your application.</p>]]></content><author><name></name></author><category term="Website"/><category term="React"/><category term="Next.js"/><category term="Webpack"/><category term="Vite"/><summary type="html"><![CDATA[There are many blogs which compare Vite and Webpack. But Vite is just a front web application tool which is similar to Create-React-App. Vite is using esbuild and Rollup to bundle resource while CRA is using webpack.]]></summary></entry></feed>