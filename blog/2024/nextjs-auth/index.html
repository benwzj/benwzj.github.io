<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Implement Auth in Next.js | BEN WEN</title> <meta name="author" content="Ben Wen"> <meta name="description" content="A website to show the world of Ben Wen "> <meta name="keywords" content="jekyll, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/mdb.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link defer rel="stylesheet" href="/assets/css/bootstrap-table.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/all.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/academicons.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/github.css?d41d8cd98f00b204e9800998ecf8427e" media="" id="highlight_theme_light"> <link rel="icon" href="/assets/img/favicon.png"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://benwzj.github.io/blog/2024/nextjs-auth/"> <link rel="stylesheet" href="/assets/css/native.css?d41d8cd98f00b204e9800998ecf8427e" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <style>html{scroll-behavior:smooth}</style> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">BEN WEN</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="nav-item"> <a class="nav-link" href="https://github.com/benwzj" rel="external nofollow noopener" target="_blank"> GitHub <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="width:1rem;height:1rem;fill:currentColor"> <g data-name="Layer 2"><g data-name="external-link"> <rect width="24" height="24" opacity="0"></rect> <path d="M20 11a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H6a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1z"></path> <path d="M16 5h1.58l-6.29 6.28a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0L19 6.42V8a1 1 0 0 0 1 1 1 1 0 0 0 1-1V4a1 1 0 0 0-1-1h-4a1 1 0 0 0 0 2z"></path> </g></g> </svg> </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="post col-sm-9"> <h1 class="post-title">Implement Auth in Next.js</h1> <br> <br> <article class="post-content"> <div id="markdown-content"> <h2 id="basic-authenticatin-process">Basic Authenticatin process</h2> <ul> <li>Login button: <ul> <li>Get user information from form.</li> <li>Verify user information.</li> <li>Create session: <ul> <li>setup information in JWT, like create signature.</li> <li>create cookie, setup expiration date, etc.</li> <li>put JWT inside cookie</li> </ul> </li> </ul> </li> <li>Every request from browser will send with this session cookie. Server check this JWT and confirm the state of the browser. <ul> <li>Also, you can use middleware to handle every request, for example refresh the session cookie.</li> </ul> </li> <li>Logout button: <ul> <li>Simply destroy the session cookie</li> </ul> </li> </ul> <h2 id="nextauth-overview">NextAuth Overview</h2> <p>NextAuth.js is an open source auth layer for Next.js project. Auth.js was born out of next-auth. And it try to support more frameworks. It keep using the name “NextAuth.js” for Next.js. Here is using “NextAuth” as well.</p> <h3 id="4-authenticate-methods">4 authenticate methods</h3> <p>There are 4 ways to authenticate users with NextAuth:</p> <ul> <li>OAuth authentication (Sign in with Google, GitHub, LinkedIn, etc…)</li> <li>Magic Links (Email Provider like Resend, Sendgrid, Nodemailer etc…)</li> <li>Credentials (Username and Password, Integrating with external APIs, etc…)</li> <li>WebAuthn (Passkeys, etc…)</li> </ul> <h3 id="framework-overview">Framework Overview</h3> <p>NextAuth provide the whole Auth framework structure. Your project will configure your authentication by using this structure. How to configure your authentication? <code class="language-plaintext highlighter-rouge">auth.config.ts</code> and <code class="language-plaintext highlighter-rouge">auth.ts</code> are the files you need to configure.</p> <p>For example signin process:</p> <ul> <li>NextAuth frameword provide <code class="language-plaintext highlighter-rouge">signin</code> function.</li> <li>To signin your users, make sure you have at least one authentication method setup.</li> <li>For example use username and password or other external authentication mechanisms, we need to setup <code class="language-plaintext highlighter-rouge">Auth.js</code> use the <code class="language-plaintext highlighter-rouge">Credentials</code> provider.</li> <li>Once a user is logged in, You can get the session object: <code class="language-plaintext highlighter-rouge">const session = await auth()</code>. Then you can get user information, you can protect the routes.</li> </ul> <h2 id="nextauth-setup">NextAuth Setup</h2> <p>The steps roughly like these:</p> <h3 id="setting-up-nextauthjs-to-your-project">Setting up NextAuth.js to your project</h3> <ul> <li>install it: <code class="language-plaintext highlighter-rouge">npm install next-auth@beta</code> </li> <li>generate a secret key for your application. This key is used to encrypt cookies, ensuring the security of user sessions. Like this: <code class="language-plaintext highlighter-rouge">openssl rand -base64 32</code> </li> <li>In your <code class="language-plaintext highlighter-rouge">.env</code> file, add your generated key to the AUTH_SECRET variable: <code class="language-plaintext highlighter-rouge">AUTH_SECRET=your-secret-key</code> </li> </ul> <h3 id="authconfigts-file">auth.config.ts file</h3> <p>Create an <code class="language-plaintext highlighter-rouge">auth.config.ts</code> file at the root of our project that exports an <code class="language-plaintext highlighter-rouge">authConfig</code> object.</p> <ul> <li>you can Add the login pages option in this config file.</li> <li>configure Protecting your routes with Next.js Middleware.</li> </ul> <h3 id="authts-file">auth.ts file</h3> <p><code class="language-plaintext highlighter-rouge">auth.ts</code> file spreads your <code class="language-plaintext highlighter-rouge">authConfig</code> object.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">NextAuth</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next-auth</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">authConfig</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./auth.config</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Credentials</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next-auth/providers/credentials</span><span class="dl">'</span><span class="p">;</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="p">{</span> <span class="nx">auth</span><span class="p">,</span> <span class="nx">signIn</span><span class="p">,</span> <span class="nx">signOut</span> <span class="p">}</span> <span class="o">=</span> <span class="nc">NextAuth</span><span class="p">({</span>
  <span class="p">...</span><span class="nx">authConfig</span><span class="p">,</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nc">Credentials</span><span class="p">({})],</span>
<span class="p">});</span>
</code></pre></div></div> <h3 id="the-login-form-for-email-and-password">The login form for email and password</h3> <p>you create the login route and component where users can input their credentials. for example, create route <code class="language-plaintext highlighter-rouge">/login</code>.This login page UI should use <code class="language-plaintext highlighter-rouge">form</code> which is using <code class="language-plaintext highlighter-rouge">authenticate()</code> Server action to authenticate user.</p> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/login/page.tsx</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">authenticate</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/app/lib/actions</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nf">Page</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return </span><span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="p">{</span><span class="nx">authenticate</span><span class="p">}</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="dl">"</span><span class="s2">Email</span><span class="dl">"</span> <span class="nx">required</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">password</span><span class="dl">"</span> <span class="nx">name</span><span class="o">=</span><span class="dl">"</span><span class="s2">password</span><span class="dl">"</span> <span class="nx">placeholder</span><span class="o">=</span><span class="dl">"</span><span class="s2">Password</span><span class="dl">"</span> <span class="nx">required</span> <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Login</span><span class="o">&lt;</span><span class="sr">/button</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/form</span><span class="err">&gt;
</span>  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>Implement <code class="language-plaintext highlighter-rouge">authenticate</code> Server Action:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/lib/actions.ts</span>
<span class="dl">'</span><span class="s1">use server</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">signIn</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/auth</span><span class="dl">'</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">_currentState</span><span class="p">:</span> <span class="nx">unknown</span><span class="p">,</span> <span class="nx">formData</span><span class="p">:</span> <span class="nx">FormData</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nf">signIn</span><span class="p">(</span><span class="dl">'</span><span class="s1">credentials</span><span class="dl">'</span><span class="p">,</span> <span class="nx">formData</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now, you can add Form Validation implement using <code class="language-plaintext highlighter-rouge">useFormState</code> (<code class="language-plaintext highlighter-rouge">useActionState</code>) and <code class="language-plaintext highlighter-rouge">useFormStatus</code>.</p> <h2 id="implement-authorization">Implement Authorization</h2> <p>Once a user is authenticated, you’ll need to think about What user can do:</p> <ul> <li>visiting certain routes</li> <li>perform operations such as mutating data with Server Actions</li> <li>calling Route Handlers</li> </ul> <h3 id="protecting-routes-with-middleware">Protecting Routes with Middleware</h3> <p>Middleware in Next.js helps you control who can access different parts of your website.</p> <p>Here’s how to implement Middleware for authentication in Next.js:</p> <ul> <li>Setting Up Middleware: <ul> <li>Create a middleware.ts or .js file in your project’s root directory.</li> <li>Include logic to authorize user access, such as checking for authentication tokens.</li> </ul> </li> <li>Defining Protected Routes: <ul> <li>Not all routes require authorization. Use the matcher option in your Middleware to specify any routes that do not require authorization checks.</li> </ul> </li> <li>Middleware Logic: <ul> <li>Write logic to verify if a user is authenticated. Check user roles or permissions for route authorization.</li> </ul> </li> <li>Handling Unauthorized Access: <ul> <li>Redirect unauthorized users to a login or error page as appropriate.</li> </ul> </li> </ul> <p>Middleware example:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//middleware.ts</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">function</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">currentUser</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">currentUser</span><span class="dl">'</span><span class="p">)?.</span><span class="nx">value</span>
 
  <span class="k">if </span><span class="p">(</span><span class="nx">currentUser</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">/dashboard</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Response</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/dashboard</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span>
  <span class="p">}</span>
 
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">currentUser</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Response</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="k">export</span> <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">matcher</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">/((?!api|_next/static|_next/image|.*</span><span class="se">\\</span><span class="s1">.png$).*)</span><span class="dl">'</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="data-access-layerdal">Data Access Layer(DAL)</h3> <ul> <li>For new next.js projects, It is good to use Data Access Layer(DAL) to consolidate all data access in there.</li> <li> <strong>The principle</strong> is that a Server Component function body should only see data that the current user issuing the request is authorized to have access to.</li> <li> <strong>The concept</strong> is that building an internal JavaScript library that provides custom data access checks before giving it to the caller. Similar to HTTP endpoints but in the same memory model.</li> <li>Every API should accept the current user and check if the user can see this data before returning it.</li> </ul> <p>From this point, normal security practices for implementing APIs take over.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// data/auth.tsx</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">cache</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">cookies</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/headers</span><span class="dl">'</span><span class="p">;</span>
 
<span class="c1">// Cached helper methods makes it easy to get the same value in many places</span>
<span class="c1">// without manually passing it around. This discourages passing it from Server</span>
<span class="c1">// Component to Server Component which minimizes risk of passing it to a Client</span>
<span class="c1">// Component.</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">getCurrentUser</span> <span class="o">=</span> <span class="nf">cache</span><span class="p">(</span><span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nf">cookies</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">AUTH_TOKEN</span><span class="dl">'</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">decodedToken</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">decryptAndValidate</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
  <span class="c1">// Don't include secret tokens or private information as public fields.</span>
  <span class="c1">// Use classes to avoid accidentally passing the whole object to the client.</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nx">decodedToken</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// data/user-dto.tsx</span>

<span class="k">import</span> <span class="dl">'</span><span class="s1">server-only</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getCurrentUser</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./auth</span><span class="dl">'</span><span class="p">;</span>
 
<span class="kd">function</span> <span class="nf">canSeeUsername</span><span class="p">(</span><span class="nx">viewer</span><span class="p">:</span> <span class="nx">User</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Public info for now, but can change</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="kd">function</span> <span class="nf">canSeePhoneNumber</span><span class="p">(</span><span class="nx">viewer</span><span class="p">:</span> <span class="nx">User</span><span class="p">,</span> <span class="nx">team</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Privacy rules</span>
  <span class="k">return</span> <span class="nx">viewer</span><span class="p">.</span><span class="nx">isAdmin</span> <span class="o">||</span> <span class="nx">team</span> <span class="o">===</span> <span class="nx">viewer</span><span class="p">.</span><span class="nx">team</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getProfileDTO</span><span class="p">(</span><span class="nx">slug</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Don't pass values, read back cached values, also solves context and easier to make it lazy</span>
 
  <span class="c1">// use a database API that supports safe templating of queries</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">rows</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">sql</span><span class="s2">`SELECT * FROM user WHERE slug = </span><span class="p">${</span><span class="nx">slug</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">userData</span> <span class="o">=</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
 
  <span class="kd">const</span> <span class="nx">currentUser</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getCurrentUser</span><span class="p">();</span>
 
  <span class="c1">// only return the data relevant for this query and not everything</span>
  <span class="c1">// &lt;https://www.w3.org/2001/tag/doc/APIMinimization&gt;</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="nf">canSeeUsername</span><span class="p">(</span><span class="nx">currentUser</span><span class="p">)</span> <span class="p">?</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">username</span> <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">phonenumber</span><span class="p">:</span> <span class="nf">canSeePhoneNumber</span><span class="p">(</span><span class="nx">currentUser</span><span class="p">,</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">team</span><span class="p">)</span>
      <span class="p">?</span> <span class="nx">userData</span><span class="p">.</span><span class="nx">phonenumber</span>
      <span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div> <p>These methods should expose objects that are safe to be transferred to the client as is. We like to call these Data Transfer Objects (DTO) to clarify that they’re ready to be consumed by the client.</p> <p>They might only get consumed by Server Components in practice. This creates a layering where security audits can focus primarily on the Data Access Layer while the UI can rapidly iterate. Smaller surface area and less code to cover makes it easier to catch security issues.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">getProfile</span><span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../data/user</span><span class="dl">'</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">Page</span><span class="p">({</span> <span class="na">params</span><span class="p">:</span> <span class="p">{</span> <span class="nx">slug</span> <span class="p">}</span> <span class="p">})</span> <span class="p">{</span>
  <span class="c1">// This page can now safely pass around this profile knowing</span>
  <span class="c1">// that it shouldn't contain anything sensitive.</span>
  <span class="kd">const</span> <span class="nx">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getProfile</span><span class="p">(</span><span class="nx">slug</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <p>Secret keys can be stored in environment variables but only the data access layer should access process.env in this approach.</p> <h3 id="protecting-server-actions">Protecting Server Actions</h3> <p>Implement checks within Server Actions to determine user permissions, such as restricting certain actions to admin users.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/lib/actions.ts</span>
<span class="dl">'</span><span class="s1">use server</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">serverAction</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getSession</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">userRole</span> <span class="o">=</span> <span class="nx">session</span><span class="p">?.</span><span class="nx">user</span><span class="p">?.</span><span class="nx">role</span>
 
  <span class="c1">// Check if user is authorized to perform the action</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">userRole</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Unauthorized access: User does not have admin privileges.</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>
 
  <span class="c1">// Proceed with the action for authorized users</span>
  <span class="c1">// ... implementation of the action</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="protecting-route-handlers">Protecting Route Handlers</h3> <p>You can do this:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/api/route.ts</span>
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">GET</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// User authentication and role verification</span>
  <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getSession</span><span class="p">()</span>
 
  <span class="c1">// Check if the user is authenticated</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Response</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="mi">401</span> <span class="p">})</span> <span class="c1">// User is not authenticated</span>
  <span class="p">}</span>
 
  <span class="c1">// Check if the user has the 'admin' role</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">role</span> <span class="o">!==</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Response</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">status</span><span class="p">:</span> <span class="mi">403</span> <span class="p">})</span> <span class="c1">// User is authenticated but does not have the right permissions</span>
  <span class="p">}</span>
 
  <span class="c1">// Data fetching for authorized users</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="authorization-using-server-components">Authorization Using Server Components</h3> <p>Server Components can direct access to back-end resources. So need do Authorization. A common practice is to conditionally render UI elements based on the user’s role. Like this:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/dashboard/page.tsx</span>

<span class="k">export</span> <span class="k">default</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">Dashboard</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getSession</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">userRole</span> <span class="o">=</span> <span class="nx">session</span><span class="p">?.</span><span class="nx">user</span><span class="p">?.</span><span class="nx">role</span> <span class="c1">// Assuming 'role' is part of the session object</span>
 
  <span class="k">if </span><span class="p">(</span><span class="nx">userRole</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">admin</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">AdminDashboard</span> <span class="o">/&gt;</span> <span class="c1">// Component for admin users</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">userRole</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">user</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">UserDashboard</span> <span class="o">/&gt;</span> <span class="c1">// Component for regular users</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">AccessDenied</span> <span class="o">/&gt;</span> <span class="c1">// Component shown for unauthorized access</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="session-management">Session Management</h2> <p>Session management involves tracking and managing a user’s interaction with the application over time, ensuring that their authenticated state is preserved across different parts of the application.</p> <p>This prevents the need for repeated logins, enhancing both security and user convenience. There are two primary methods used for session management:</p> <ul> <li>cookie-based (storing session data on the User Browser, data should be encrypted)</li> <li>database sessions（storing session data on the server）</li> </ul> <h3 id="implement-cookie-based-session-management">Implement cookie-based Session management</h3> <p>Setting a cookie on the server action:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/actions.ts</span>
<span class="dl">'</span><span class="s1">use server</span><span class="dl">'</span> 
<span class="k">import</span> <span class="p">{</span> <span class="nx">cookies</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/headers</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">handleLogin</span><span class="p">(</span><span class="nx">sessionData</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">encryptedSessionData</span> <span class="o">=</span> <span class="nf">encrypt</span><span class="p">(</span><span class="nx">sessionData</span><span class="p">)</span> <span class="c1">// Encrypt your session data using JWT</span>
  <span class="nf">cookies</span><span class="p">().</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">session</span><span class="dl">'</span><span class="p">,</span> <span class="nx">encryptedSessionData</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">secure</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">maxAge</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="c1">// One week</span>
    <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">})</span>
  <span class="c1">// Redirect or handle the response after setting the cookie</span>
<span class="p">}</span>
</code></pre></div></div> <p>Accessing the session data stored in the cookie in a server component:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/page.tsx</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">cookies</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/headers</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">getSessionData</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">encryptedSessionData</span> <span class="o">=</span> <span class="nf">cookies</span><span class="p">().</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">session</span><span class="dl">'</span><span class="p">)?.</span><span class="nx">value</span>
  <span class="k">return</span> <span class="nx">encryptedSessionData</span> <span class="p">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nf">decrypt</span><span class="p">(</span><span class="nx">encryptedSessionData</span><span class="p">))</span> <span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="faq">FAQ</h2> <ul> <li>How NextAuth.js implement OIDC authentication?</li> <li>What <code class="language-plaintext highlighter-rouge">signIn()</code> do in NextAuth.js?</li> <li>How to implement Data Access Layer(DAL)</li> </ul> <h2 id="references">References</h2> <ul> <li><a href="https://next-auth.js.org" rel="external nofollow noopener" target="_blank">NextAuth.js Doc</a></li> <li> <a href="https://authjs.dev/reference/next-auth" rel="external nofollow noopener" target="_blank">Auth.js Doc</a>.</li> <li><a href="https://nextjs.org/blog/security-nextjs-server-components-actions" rel="external nofollow noopener" target="_blank">Blog: Security in Next.js</a></li> </ul> </div> </article> </div> <div class="col-sm-3 post-side-container"> <div class="card hoverable post-side-sticky"> <div class="card-body post-side-detail"> <h5 class="card-title">Post Detail</h5> <div class="detail-item"> <div class="item-title">Published : </div> <div class="item-content">Jun 13, 2024</div> </div> <div class="detail-item"> <div class="item-title">Category : </div> <div class="item-content"> <a href="/blog/category/react"> <i class="fas fa-tag fa-sm"></i> React</a> </div> </div> <div class="detail-item"> <div class="item-title">Tags : </div> </div> <div class="tags"> <a href="/blog/tag/next-js"> <div class="tag"> Next.js </div> </a> <a href="/blog/tag/javascript"> <div class="tag"> JavaScript </div> </a> <a href="/blog/tag/react"> <div class="tag"> React </div> </a> <a href="/blog/tag/authentication"> <div class="tag"> Authentication </div> </a> <a href="/blog/tag/authorization"> <div class="tag"> Authorization </div> </a> <a href="/blog/tag/jwt"> <div class="tag"> JWT </div> </a> </div> <div class="detail-item"> <div class="item-title">Content : </div> </div> <div class="toc-container"> <div class="toc-item"> <a href="#basic-authenticatin-process"> # Basic Authenticatin process </a> </div> <div class="toc-item"> <a href="#nextauth-overview"> # NextAuth Overview </a> </div> <div class="toc-item"> <a href="#implement-authentication"> # Implement Authentication </a> </div> <div class="toc-item"> <a href="#implement-authorization"> # Implement Authorization </a> </div> <div class="toc-item"> <a href="#session-management"> # Session Management </a> </div> </div> </div> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Ben Wen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/assets/js/jquery.min.js?d41d8cd98f00b204e9800998ecf8427e"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="/assets/js/tex-mml-chtml.js?d41d8cd98f00b204e9800998ecf8427e"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>