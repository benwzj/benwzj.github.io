<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Auth Concepts Overview | BEN WEN</title> <meta name="author" content="Ben Wen"> <meta name="description" content="A website to show the world of Ben Wen "> <meta name="keywords" content="jekyll, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/mdb.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link defer rel="stylesheet" href="/assets/css/bootstrap-table.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/all.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/academicons.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/github.css?d41d8cd98f00b204e9800998ecf8427e" media="" id="highlight_theme_light"> <link rel="icon" href="/assets/img/favicon.png"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://benwzj.github.io/blog/2024/auth/"> <link rel="stylesheet" href="/assets/css/native.css?d41d8cd98f00b204e9800998ecf8427e" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <style>html{scroll-behavior:smooth}</style> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">BEN WEN</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="nav-item"> <a class="nav-link" href="https://github.com/benwzj" rel="external nofollow noopener" target="_blank"> GitHub <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="width:1rem;height:1rem;fill:currentColor"> <g data-name="Layer 2"><g data-name="external-link"> <rect width="24" height="24" opacity="0"></rect> <path d="M20 11a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H6a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1z"></path> <path d="M16 5h1.58l-6.29 6.28a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0L19 6.42V8a1 1 0 0 0 1 1 1 1 0 0 0 1-1V4a1 1 0 0 0-1-1h-4a1 1 0 0 0 0 2z"></path> </g></g> </svg> </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="post col-sm-9"> <h1 class="post-title">Auth Concepts Overview</h1> <br> <br> <article class="post-content"> <div id="markdown-content"> <p>Try to clear the main Auth concepts from higher perspective.</p> <h2 id="term-overview">Term Overview</h2> <h3 id="oauth-vs-openid-vs-oidc">OAuth vs OpenID vs OIDC</h3> <ul> <li>OpenID is based on a simple idea: a user authenticates with an identity provider (IDP), who then provides the user with a <strong>unique identifier</strong> (called an OpenID). This identifier can then be used to authenticate the user with any website that supports OpenID.</li> <li>OAuth(Open Authorization), Originally designed to for applications to get access to APIs. grants access to Other resources via <strong>Access Tokens</strong>.</li> <li>OpenID Connect (OIDC) is an identity layer built on top of the OAuth 2.0 framework. It allows third-party applications to verify the identity of the end-user and to obtain basic user profile information. OIDC uses JWTs, which you can obtain using flows conforming to the OAuth 2.0 specifications. Simply saying, it adds an <strong>additional token</strong> called <strong>ID Token</strong>.</li> </ul> <h4 id="anology">Anology</h4> <p>Let’s understand that like this: a Guest check at a hotel reception with ID card, then reception give him a digit key which can unlock a hotel room, or visit gym, swiming pool, etc. Hotel room lock just accept the key and don’t care who use it. Guest is User, Reception is OpenID IDP(Authentication), digit card is Access token. Now, there is a apecial service, kid care, which need digit key, and User information to show up as well. OAuth can do nothing about this, but OIDC can do it!</p> <h3 id="oidc-and-jwt">OIDC and JWT</h3> <p>Each time you need to log in to a website using OIDC, you are redirected to your OpenID site where you log in, and then taken back to the website. For example, if you chose to sign in to Auth0 using your Google account then you used OIDC. Once you successfully authenticate with Google and authorize Auth0 to access your information, Google sends information back to Auth0 about the user and the authentication performed. This information is returned in a JWT. You’ll receive an access token and if requested, an ID token.</p> <p>The OIDC specification defines a set of standard claims for JWT. The set of standard claims include name, email, gender, birth date, and so on. However, if you want to capture information about a user and there currently isn’t a standard claim that best reflects this piece of information, you can create custom claims and add them to your tokens.</p> <h3 id="how-is-oidc-different-from-openid20">How is OIDC different from OpenID2.0?</h3> <p>OIDC has many architectural similarities to OpenID 2.0, and in fact the protocols solve a very similar set of problems. However, OpenID 2.0 used <strong>XML</strong> and a custom message signature scheme that in practice sometimes proved difficult for developers to get right, with the effect that OpenID 2.0 implementations would sometimes mysteriously refuse to interoperate. OAuth 2.0, the substrate for OpenID Connect, outsources the necessary encryption to the Web’s built-in TLS (also called HTTPS or SSL) infrastructure, which is universally implemented on both client and server platforms. OpenID Connect uses standard <strong>JWT</strong> data structures when signatures are required. This makes OpenID Connect dramatically easier for developers to implement, and in practice has resulted in much better interoperability.</p> <h3 id="more-concrete-way-to-understand-the-concepts">More concrete way to understand the concepts</h3> <ul> <li>Authentication = Identifying user</li> <li>Authorization = Accessing APIs</li> </ul> <h2 id="jwt-overview">JWT Overview</h2> <p>JSON Web Token (JWT) defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally <strong>signed</strong>.</p> <ul> <li>JWTs can be <strong>signed</strong> using a secret (with the HMAC algorithm) or a public/private key pair using RSA or ECDSA.</li> <li>Although JWT can be encrypted to also provide secrecy between parties, It will focus on <strong>signed</strong> tokens.</li> <li>Because most of JWTS are not encrypted, you can read them.</li> <li>It need to be used with HTTPS connection.</li> </ul> <h3 id="two-common-usage-scenarios">TWO common usage scenarios</h3> <ul> <li> <strong>Authorization</strong>: This is the most common scenario for using JWT. Once the user is logged in, each subsequent request will include the JWT, allowing the user to access routes, services, and resources that are permitted with that token. Single Sign On is a feature that widely uses JWT nowadays, because of its small overhead and its ability to be easily used across different domains.</li> <li> <strong>Information Exchange</strong>: JSON Web Tokens are a good way of securely transmitting information between parties. Because JWTs can be signed — for example, using public/private key pairs — you can be sure the senders are who they say they are. Additionally, as the signature is calculated using the header and the payload, you can also verify that the content hasn’t been tampered with.</li> </ul> <h3 id="jwt-structure">JWT structure</h3> <p>Three parts separated by dots (.), which are:</p> <ul> <li>Header</li> <li>Payload</li> <li>Signature</li> </ul> <p>Like this:</p> <figure> <picture> <img src="/assets/img/encoded-jwt3.png" class="img-fluid rounded z-depth-1" width="80%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Header and Payload are just plain text that get encoded, but not encrypted. So everyone can read them. JWT just focus on signed.</p> <h3 id="client-sidestateless-sessions">Client-side/Stateless Sessions</h3> <p>The so-called stateless sessions are in fact nothing more than client-side data. Most of the time sessions need only be signed. In other words, there is no security or privacy concern when data stored in them is read by third parties. client-side data can be suffered Security attack like, Signature Stripping, CSRF, XSS. Use JWT propertly can protect. For example adding CSRF mitigation techniques. Sometime a certain balance between client-side data and database lookups in the backend is necessary.</p> <h3 id="one-concrete-example">One Concrete Example</h3> <p>Here copy a example to show how to use JWT.</p> <p>For example we will make a simple shopping application. The user’s shopping cart will be stored client-side. In this example, there are multiple JWTs present. Our shopping cart will be one of them.</p> <ul> <li>One JWT for the ID token, a token that carries the user’s profile information, useful for the UI.</li> <li>One JWT for interacting with the API backend (the access token).</li> <li>One JWT for our client-side state: the shopping cart. Here’s how the shopping cart looks when decoded: <div class="language-json highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="mi">4</span><span class="w">
  </span><span class="p">],</span><span class="w">
</span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1493139659</span><span class="p">,</span><span class="w">
</span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1493143259</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div> </div> <p>Each item is identified by a numeric ID. The encoded and signed JWT looks like:</p> <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
eyJpdGVtcyI6WzAsMiw0XSwiaWF0IjoxNDkzMTM5NjU5LCJleHAiOjE0OTMxNDMyNTl9.
932ZxtZzy1qhLXs932hd04J58Ihbg5_g_rIrj-Z16Js
</code></pre></div> </div> <p>To render the items in the cart, the frontend only needs to retrieve it from its cookie:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">populateCart</span><span class="p">()</span> <span class="p">{</span>
<span class="kd">const</span> <span class="nx">cartElem</span> <span class="o">=</span> <span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#cart</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">cartElem</span><span class="p">.</span><span class="nf">empty</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">cartToken</span> <span class="o">=</span> <span class="nx">Cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">cart</span><span class="dl">'</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">cartToken</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">cart</span> <span class="o">=</span> <span class="nf">jwt_decode</span><span class="p">(</span><span class="nx">cartToken</span><span class="p">).</span><span class="nx">items</span><span class="p">;</span>
<span class="nx">cart</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">itemId</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">items</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">itemId</span><span class="p">).</span><span class="nx">name</span><span class="p">;</span>
  <span class="nx">cartElem</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s2">`&lt;li&gt;</span><span class="p">${</span><span class="nx">name</span><span class="p">}</span><span class="s2">&lt;/li&gt;`</span><span class="p">);</span>
<span class="p">});</span>
<span class="p">}</span>
</code></pre></div> </div> <p>The actual checks are performed by the backend. All JWTs are verified. Here is the backend check for the validity of the cart JWT implemented as an Express middleware:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">cartValidator</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">cart</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">cart</span> <span class="o">=</span> <span class="p">{</span> <span class="na">items</span><span class="p">:</span> <span class="p">[]</span> <span class="p">};</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">cart</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">items</span><span class="p">:</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">verify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">cart</span><span class="p">,</span>
      <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AUTH0_CART_SECRET</span><span class="p">,</span>
      <span class="nx">cartVerifyJwtOptions</span><span class="p">).</span><span class="nx">items</span>
    <span class="p">};</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">cart</span> <span class="o">=</span> <span class="p">{</span> <span class="na">items</span><span class="p">:</span> <span class="p">[]</span> <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nf">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div> </div> <p>When items are added, the backend constructs a new JWT with the new item in it and a new signature:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/protected/add_item</span><span class="dl">'</span><span class="p">,</span> <span class="nx">idValidator</span><span class="p">,</span> <span class="nx">cartValidator</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="nx">req</span><span class="p">.</span><span class="nx">cart</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nf">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
<span class="kd">const</span> <span class="nx">newCart</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cart</span><span class="p">,</span>
<span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AUTH0_CART_SECRET</span><span class="p">,</span>
<span class="nx">cartSignJwtOptions</span><span class="p">);</span>
<span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">cart</span><span class="dl">'</span><span class="p">,</span> <span class="nx">newCart</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">maxAge</span><span class="p">:</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
<span class="p">});</span>
<span class="nx">res</span><span class="p">.</span><span class="nf">end</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Item ID </span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2"> added to cart.`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div> </div> <p>Note that locations prefixed by /protected are also protected by the API access token. This is setup using express-jwt:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/protected</span><span class="dl">'</span><span class="p">,</span> <span class="nf">expressJwt</span><span class="p">({</span>
<span class="na">secret</span><span class="p">:</span> <span class="nx">jwksClient</span><span class="p">.</span><span class="nf">expressJwtSecret</span><span class="p">(</span><span class="nx">jwksOpts</span><span class="p">),</span>
<span class="na">issuer</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AUTH0_API_ISSUER</span><span class="p">,</span>
<span class="na">audience</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">AUTH0_API_AUDIENCE</span><span class="p">,</span>
<span class="na">requestProperty</span><span class="p">:</span> <span class="dl">'</span><span class="s1">accessToken</span><span class="dl">'</span><span class="p">,</span>
<span class="na">getToken</span><span class="p">:</span> <span class="nx">req</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">[</span><span class="dl">'</span><span class="s1">access_token</span><span class="dl">'</span><span class="p">];</span>
<span class="p">}</span>
<span class="p">}));</span>
</code></pre></div> </div> <p>In other words, the <code class="language-plaintext highlighter-rouge">/protected/add_item</code> endpoint must first pass the access token validation step before validating the cart. One token validates access (authorization) to the API and the other token validates the integrity of the client side data (the cart). The access token and the ID token are assigned by Auth0 to our application. This requires setting up a client and an API endpoint using the Auth0 dashboard. These are then retrieved using the Auth0 JavaScript library, called by our frontend:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="c1">//Auth0 Client ID</span>
<span class="kd">const</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">t42WY87weXzepAdUlwMiHYRBQj9qWVAT</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">//Auth0 Domain</span>
<span class="kd">const</span> <span class="nx">domain</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">speyrott.auth0.com</span><span class="dl">"</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">auth0</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">auth0</span><span class="p">.</span><span class="nc">WebAuth</span><span class="p">({</span>
<span class="na">domain</span><span class="p">:</span> <span class="nx">domain</span><span class="p">,</span>
<span class="na">clientID</span><span class="p">:</span> <span class="nx">clientId</span><span class="p">,</span>
<span class="na">audience</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/protected</span><span class="dl">'</span><span class="p">,</span>
<span class="na">scope</span><span class="p">:</span> <span class="dl">'</span><span class="s1">openid profile purchase</span><span class="dl">'</span><span class="p">,</span>
<span class="na">responseType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">id_token token</span><span class="dl">'</span><span class="p">,</span>
<span class="na">redirectUri</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:3000/auth/</span><span class="dl">'</span><span class="p">,</span>
<span class="na">responseMode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">form_post</span><span class="dl">'</span>
<span class="p">});</span>
<span class="c1">//(...)</span>
<span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#login-button</span><span class="dl">'</span><span class="p">).</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">auth0</span><span class="p">.</span><span class="nf">authorize</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div> </div> <p>The audience claim must match the one setup for your API endpoint using the Auth0 dashboard. The Auth0 authentication and authorization server displays a login screen with our settings and then redirects back to our application at a specific path with the tokens we requested. These are handled by our backend which simply sets them as cookies:</p> <div class="language-js highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/auth</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">access_token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">access_token</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">maxAge</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">expires_in</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="p">});</span>
<span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">id_token</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">id_token</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">maxAge</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">expires_in</span> <span class="o">*</span> <span class="mi">1000</span>
<span class="p">});</span>
<span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div> </div> </li> </ul> <p>You can Implement CSRF mitigation techniques on the top of this example.</p> <h2 id="oauth2-overview">OAuth2 Overview</h2> <h3 id="oauth-concept">OAuth Concept</h3> <p>OAuth, or Open Authorization, is a standard that allows users to authorize apps to access their data and resources without sharing their login credentials. OAuth uses access tokens to grant temporary access to third parties. These tokens contain information about the user and the resource, as well as specific rules for data sharing.</p> <p>There are different OAuth Flow for defferent app types:</p> <ul> <li>Single-page app (SPA)</li> <li>Web app</li> <li>Web API</li> <li>Mobile and native apps</li> <li>Service, daemon, script</li> </ul> <h3 id="oauth-benefits">OAuth Benefits</h3> <p>OAuth allows users to:</p> <ul> <li>Share specific data with an application while keeping their usernames, passwords, and other information private</li> <li>Use one-click logins to identify themselves to a web service without having to enter their username and password every time</li> </ul> <h3 id="what-is-oauth-apps">What is OAuth Apps</h3> <p>You need to Creating an OAuth Apps first before you can use OAuth.</p> <p>OAuth apps are applications that use the OAuth protocol to allow users to grant third-party access to their data without sharing their password.</p> <p>For Example: Vercel provide Server platform for developer to deploy their application which code can be store in GitHub. If you want to allow Vercel to access GitHub to deploy your application, you need to install an OAuth app in your Repo. After the OAuth installation, Vercel can access that Reop.</p> <p>MobilePrinter must first register a new app with the service.</p> <ul> <li>You must register a redirect URI to be used for redirecting users to for web server.</li> <li>You will get Client ID and Secret.</li> </ul> <h3 id="authorization-process">Authorization process</h3> <p>Let’s say, you are developing a MobilePrinter Website App which using OAuth process. This App can help users print photo in Other server, like Google photos.</p> <p>There are 4 Roles:</p> <ul> <li>The Third-Party Application, “Client”, MobilePrinter Website App</li> <li>The API: “Resource Server”, Visiting Google photos</li> <li>The Authorization Server: Google</li> <li>The User: “Resource Owner”</li> </ul> <p>MobilePrinter Website use Client ID and Secret communicate with the authorization server, (Google).</p> <ul> <li>Create a “Log In” link sending the user to: <code class="language-plaintext highlighter-rouge">https://authorization-server.com/auth?response_type=code&amp;client_id=CLIENT_ID&amp;redirect_uri=REDIRECT_URI&amp;scope=photos&amp;state=1234zyx</code> </li> <li>The user sees the authorization prompt (Allow or Deny) from authorization-server.</li> <li>If the user clicks “Allow” the authorization-service redirects the user back to your site with an authorization code: <code class="language-plaintext highlighter-rouge">https://example-app.com/cb?code=AUTH_CODE_HERE&amp;state=1234zyx</code> </li> <li>To Get an Access Token, Your server should exchanges the authorization code for an access token by making a POST request to the authorization server’s token endpoint: <div class="language-plaintext highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>POST https://api.authorization-server.com/token
grant_type=authorization_code&amp;
code=AUTH_CODE_HERE&amp;
redirect_uri=REDIRECT_URI&amp;
client_id=CLIENT_ID&amp;
client_secret=CLIENT_SECRET
</code></pre></div> </div> </li> <li>The server replies with an access token and expiration time <div class="language-json highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
</span><span class="nl">"access_token"</span><span class="p">:</span><span class="s2">"RsT5OjbzRn430zqMLgV3Ia"</span><span class="p">,</span><span class="w">
</span><span class="nl">"expires_in"</span><span class="p">:</span><span class="mi">3600</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div> </div> </li> </ul> <h2 id="session-management">Session Management</h2> <p>Session management involves tracking and managing a user’s interaction with the application over time, ensuring that their authenticated state is preserved across different parts of the application.</p> <p>This prevents the need for repeated logins, enhancing both security and user convenience. There are two primary methods used for session management:</p> <ul> <li>cookie-based (storing session data on the User Browser, data should be encrypted)</li> <li>database sessions（storing session data on the server）</li> </ul> <h3 id="jwt-sessions-vs-database-sessions">JWT Sessions vs Database Sessions</h3> <ul> <li>JWT refer to as stateless. Dataase is the opposite, stateful.</li> <li>Both need cookie (http-only). Database session use cookie for SessionID and JWT use cookies to store more information.</li> <li>JWT need bigger and more cookies; But reduce the interact between server and database.</li> <li>Database Sessions can be safer.</li> <li>JWT also good for Single Sign On.</li> </ul> <h2 id="authentication-solutions">Authentication Solutions</h2> <ul> <li>There are many authentication solutions. Like, Auth0, Clerk, Kinde etc.</li> <li>You can add these solutions to your application.</li> <li>They all support Modern authentication strategies, like OAuth/OpenID Connect (OIDC), Credentials-based login (Email + Password), Passwordless/Token-based authentication.</li> </ul> <h2 id="faq">FAQ</h2> <ul> <li>Common use case for JWT?</li> <li>How JWT implement authorization?</li> <li>What is Cross-Site Request Forgery (CSRF)?</li> <li>What is Cross-Site Scripting (XSS)?</li> <li>How is OIDC different from OpenID2.0?</li> </ul> <h3 id="what-is-cross-site-request-forgery-csrf">What is Cross-Site Request Forgery (CSRF)?</h3> <p>Unlike cross-site scripting (XSS), which exploits the trust a user has for a particular site, CSRF exploits the trust that a site has in a user’s browser. In a CSRF attack, an innocent end user is tricked by an attacker into submitting a web request that they did not intend. This may cause actions to be performed on the website that can include inadvertent client or server data leakage, change of session state, or manipulation of an end user’s account.</p> <h3 id="what-is-cross-site-scripting-xss">What is Cross-Site Scripting (XSS)</h3> <p>Cross-site scripting (XSS) attacks attempt to inject JavaScript in trusted sites. Injected JavaScript can then steal tokens from cookies and local storage. If an access token is leaked before it expires, a malicious user could use it to access protected resources.</p> <ul> <li>Don’t use localStorage, cause JS can read it.</li> <li>use cookie with ‘http-only’ setting.</li> </ul> <h3 id="how-jwt-implement-authorization">How JWT implement authorization</h3> <p>JWTs are self-contained, all the necessary information is there, reducing the need of going back and forward to the database. JWTs can container Authorization information.</p> <h2 id="references">References</h2> <ul> <li><a href="https://jwt.io/introduction" rel="external nofollow noopener" target="_blank">jwt.io</a></li> <li><a href="https://aaronparecki.com/oauth-2-simplified/" rel="external nofollow noopener" target="_blank">OAuth2 simplified</a></li> <li>jwt-handbook-v0_14_2.pdf</li> </ul> </div> </article> </div> <div class="col-sm-3 post-side-container"> <div class="card hoverable post-side-sticky"> <div class="card-body post-side-detail"> <h5 class="card-title">Post Detail</h5> <div class="detail-item"> <div class="item-title">Published : </div> <div class="item-content">Jun 15, 2024</div> </div> <div class="detail-item"> <div class="item-title">Category : </div> <div class="item-content"> <a href="/blog/category/auth"> <i class="fas fa-tag fa-sm"></i> Auth</a> </div> </div> <div class="detail-item"> <div class="item-title">Tags : </div> </div> <div class="tags"> <a href="/blog/tag/authentication"> <div class="tag"> Authentication </div> </a> <a href="/blog/tag/authorization"> <div class="tag"> Authorization </div> </a> <a href="/blog/tag/jwt"> <div class="tag"> JWT </div> </a> <a href="/blog/tag/oauth"> <div class="tag"> OAuth </div> </a> <a href="/blog/tag/openid"> <div class="tag"> OpenID </div> </a> <a href="/blog/tag/oidc"> <div class="tag"> OIDC </div> </a> </div> <div class="detail-item"> <div class="item-title">Content : </div> </div> <div class="toc-container"> <div class="toc-item"> <a href="#term-overview"> # Term Overview </a> </div> <div class="toc-item"> <a href="#jwt-overview"> # JWT Overview </a> </div> <div class="toc-item"> <a href="#one-concrete-example">     # One Concrete Example </a> </div> <div class="toc-item"> <a href="#oauth2-overview"> # OAuth2 Overview </a> </div> <div class="toc-item"> <a href="#oauth-concept">     # OAuth Concept </a> </div> <div class="toc-item"> <a href="#what-is-oauth-apps">     # What is OAuth Apps </a> </div> <div class="toc-item"> <a href="#authorization-process">     # Authorization process </a> </div> <div class="toc-item"> <a href="#session-management"> # Session Management </a> </div> <div class="toc-item"> <a href="#authentication-solutions"> # Authentication Solutions </a> </div> <div class="toc-item"> <a href="#faq"> # FAQ </a> </div> <div class="toc-item"> <a href="#references"> # References </a> </div> </div> </div> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Ben Wen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/assets/js/jquery.min.js?d41d8cd98f00b204e9800998ecf8427e"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="/assets/js/tex-mml-chtml.js?d41d8cd98f00b204e9800998ecf8427e"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>