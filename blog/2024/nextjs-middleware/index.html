<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Next.js Middleware | BEN WEN</title> <meta name="author" content="Ben Wen"> <meta name="description" content="A website to show the world of Ben Wen "> <meta name="keywords" content="jekyll, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/mdb.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link defer rel="stylesheet" href="/assets/css/bootstrap-table.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/all.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/academicons.min.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/github.css?d41d8cd98f00b204e9800998ecf8427e" media="" id="highlight_theme_light"> <link rel="icon" href="/assets/img/favicon.png"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://benwzj.github.io/blog/2024/nextjs-middleware/"> <link rel="stylesheet" href="/assets/css/native.css?d41d8cd98f00b204e9800998ecf8427e" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <style>html{scroll-behavior:smooth}</style> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">BEN WEN</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/about/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="nav-item"> <a class="nav-link" href="https://github.com/benwzj" rel="external nofollow noopener" target="_blank"> GitHub <svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" style="width:1rem;height:1rem;fill:currentColor"> <g data-name="Layer 2"><g data-name="external-link"> <rect width="24" height="24" opacity="0"></rect> <path d="M20 11a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H6a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1z"></path> <path d="M16 5h1.58l-6.29 6.28a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0L19 6.42V8a1 1 0 0 0 1 1 1 1 0 0 0 1-1V4a1 1 0 0 0-1-1h-4a1 1 0 0 0 0 2z"></path> </g></g> </svg> </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="post col-sm-9"> <h1 class="post-title">Next.js Middleware</h1> <br> <br> <article class="post-content"> <div id="markdown-content"> <h2 id="overview">Overview</h2> <p>Next.js copy the middleware concept from Express.js.</p> <p>In Next.js, Middleware allows you to run code before a request is completed. It is based on the incoming request, you can modify the response by rewriting, redirecting, modifying the request or response headers, or responding directly.</p> <p>But the Next.js documents is not good enough.</p> <h3 id="important-points">Important Points</h3> <ul> <li>Middleware will affect every request, so need to handle it carefully.</li> <li>Middleware let you share and reuse logic that is repeatable for every request.</li> <li>Middleware runs before cached content and routes are matched.</li> <li>Middleware run for all request, Normally, you need to use <code class="language-plaintext highlighter-rouge">matcher</code> to filter “Middleware” to run on specific paths.</li> <li>The Middleware file “/middleware.ts” must export a <code class="language-plaintext highlighter-rouge">middleware</code> or a <code class="language-plaintext highlighter-rouge">default</code> function.</li> </ul> <h3 id="what-middleware-can-do">What Middleware can do:</h3> <ul> <li>redirect the incoming request to a different URL</li> <li>rewrite the response</li> <li>Set request headers for API Routes, getServerSideProps, and rewrite destinations</li> <li>Set response cookies</li> <li>Set response headers</li> </ul> <h3 id="when-to-use-middleware">When to use Middleware:</h3> <ul> <li>Authentication and Authorization</li> <li>Server-Side Redirects</li> <li>Path Rewriting, For example: A/B testing, feature rollouts, or legacy paths</li> <li>Bot Detection</li> <li>Logging and Analytics</li> <li>Feature Flagging</li> </ul> <h3 id="matching-paths">Matching Paths</h3> <p>Middleware will be invoked for every route in your project. The following is the execution order:</p> <ol> <li>headers from next.config.js</li> <li>redirects from next.config.js</li> <li>Middleware (rewrites, redirects, etc.)</li> <li>beforeFiles (rewrites) from next.config.js</li> <li>Filesystem routes (public/, _next/static/, pages/, app/, etc.)</li> <li>afterFiles (rewrites) from next.config.js</li> <li>Dynamic Routes (/blog/[slug])</li> <li>fallback (rewrites) from next.config.js</li> </ol> <p>There are two ways to define which paths Middleware will run on:</p> <ol> <li>Custom matcher config</li> <li>Conditional statements</li> </ol> <h2 id="understand-middleware">Understand middleware</h2> <p>Middleware logic happen inside the request-response cycle.</p> <h3 id="what-is-the-middleware-logic">What is the Middleware logic</h3> <p>I believe it should be this at the first thought: Client (send Request) —-&gt; Middleware(It do something) —–&gt; Route page(handle the Request) Then: Route Page (rend back Response) —-&gt; Middleware (then do something) —&gt; Client (get Response)</p> <p>But after few days research, the logic maybe not like that. It may be like this: Client (send Request) —-&gt; Middleware(It do something) —–&gt; Route page(handle the Request) Then: Route Page (rend back Response) —-&gt; Client (get Response)</p> <p>It is easier for SW design.</p> <h3 id="export-middleware-function-in-middlewarets">export middleware function in middleware.ts</h3> <p>The Middleware “/middleware” must export a <code class="language-plaintext highlighter-rouge">middleware</code> or a <code class="language-plaintext highlighter-rouge">default</code> function.</p> <p>Basic example:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>

<span class="c1">// This function can be marked `async` if using `await` inside</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="dl">'</span><span class="s1">/home</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// See "Matching Paths" below to learn more</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">matcher</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/about/:path*</span><span class="dl">'</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="what-do-the-returned-value-of-the-middleware-funciton-means">What do the returned value of the middleware funciton means?</h3> <p>What i get Till now is that:</p> <ul> <li>Return <code class="language-plaintext highlighter-rouge">Response</code> or <code class="language-plaintext highlighter-rouge">NextResponse</code> object, then it will response back to client directly.</li> <li>Return <code class="language-plaintext highlighter-rouge">NextResponse.next()</code> will pass the request to the next middleware or route.</li> <li>Return <code class="language-plaintext highlighter-rouge">NextResponse.redirect('/login')</code> will redirect to <code class="language-plaintext highlighter-rouge">/login</code>.</li> <li>How about no <code class="language-plaintext highlighter-rouge">return</code>?</li> </ul> <h3 id="understand-nextresponse">Understand NextResponse</h3> <h4 id="what-do-nextresponsenext-mean">What do NextResponse.next() mean?</h4> <ul> <li> <p>In Middleware, The <code class="language-plaintext highlighter-rouge">NextResponse.next()</code> method allows you to return early and continue routing. What do it mean? The next() method passes the request to the next middleware or route.</p> </li> <li> <p>In Middleware, The <code class="language-plaintext highlighter-rouge">NextResponse.next()</code> also allow you to forward headers when producing the response. Like this: ```ts import { NextResponse } from “next/server”; import type { NextRequest } from “next/server”;</p> </li> </ul> <p>export function middleware(request: NextRequest) { // Add a new header x-current-path which passes the path to downstream components const headers = new Headers(request.headers); headers.set(“x-current-path”, request.nextUrl.pathname); return NextResponse.next({ headers }); }</p> <p>export const config = { matcher: [ // match all routes except static files and APIs “/((?!api|_next/static|_next/image|favicon.ico).*)”, ], };</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>we can look for the `x-current-path` header in server component:
```ts
import { headers } from "next/headers";
 
export default async function Sidebar() {
  const headerList = headers();
  const pathname = headerList.get("x-current-path");

  // ...etc
}
</code></pre></div></div> <p>How this happen underneath? Why server component can get header information which set by <code class="language-plaintext highlighter-rouge">NextResponse.next</code>?</p> <h2 id="use-middleware-in-nextjs">Use Middleware in Next.js</h2> <ul> <li>Use the file <code class="language-plaintext highlighter-rouge">middleware.ts</code> (or .js) in the <strong>root</strong> of your project to define Middleware.</li> <li>Only one <code class="language-plaintext highlighter-rouge">middleware.ts</code> file is supported per project</li> <li>Because Middleware will be invoked for every route in your project, so you should use <code class="language-plaintext highlighter-rouge">matchers</code> to precisely target or exclude specific routes. Or using Conditional Statements in <code class="language-plaintext highlighter-rouge">middleware.ts</code>.</li> </ul> <h3 id="redirect">redirect</h3> <ul> <li> <code class="language-plaintext highlighter-rouge">redirect</code> the incoming request to a different URL.</li> <li> <code class="language-plaintext highlighter-rouge">rewrite</code> the response by displaying a given URL. The difference between <code class="language-plaintext highlighter-rouge">redirect</code> and <code class="language-plaintext highlighter-rouge">rewrite</code> is that , <code class="language-plaintext highlighter-rouge">rewrite</code> don’t show the handleing URL to user. ```ts //middleware.ts import { NextResponse } from ‘next/server’; import type { NextRequest } from ‘next/server’;</li> </ul> <p>export function authenticationMiddleware(request: NextRequest) { // Check if the user is authenticated if (!request.headers.cookie?.includes(‘authenticated=true’)) { return NextResponse.redirect(‘/login’); } return NextResponse.next(); // Continue to the next Middleware or route handler }</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Response to Client directly
Middleware can produce responses directly by returning a Response or NextResponse instance.
```ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function customResponseMiddleware(request: NextRequest) {
  if (/* Some condition */) {
    return new Response('Custom error message', { status: 400 }); // response to Client directly
  }
  return NextResponse.next(); // pass to the next Middleware or Route handler. 
}
</code></pre></div></div> <h3 id="add-header-and-cookie">Add header and cookie</h3> <p>Middleware can manipulate headers and cookies in both incoming requests and outgoing responses. This is useful for tasks like customizing the response or managing user sessions.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">customHeadersMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">x-current-path</span><span class="dl">'</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">);</span> 
  <span class="nx">response</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Middleware-Set-Cookie</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">123</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="modifying-request-headers">Modifying Request Headers</h3> <p>You can use Middleware to modify the headers of outgoing API requests. This is often done to add authentication tokens, API keys, or other necessary information to the headers before sending the request.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">apiInterceptorMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Modify the API request headers</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Bearer myAccessToken</span><span class="dl">'</span><span class="p">);</span>

  <span class="c1">// Cache API responses for improved performance</span>
  <span class="c1">// Implement caching logic here</span>

  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="caching-api-responses">Caching API Responses</h3> <p>To improve the performance of your application, you can implement caching of API responses within Middleware. This helps reduce the load on external APIs and speeds up subsequent requests for the same data.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">apiInterceptorMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check if the response is already cached</span>
  <span class="kd">const</span> <span class="nx">cachedResponse</span> <span class="o">=</span> <span class="cm">/* Implement caching logic here */</span><span class="p">;</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">cachedResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If cached, return the cached response</span>
    <span class="k">return</span> <span class="nx">cachedResponse</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// If not cached, make the API request and cache the response</span>
    <span class="kd">const</span> <span class="nx">apiResponse</span> <span class="o">=</span> <span class="cm">/* Make the API request */</span><span class="p">;</span>

    <span class="c1">// Cache the response for future use</span>
    <span class="cm">/* Cache the response */</span>

    <span class="k">return</span> <span class="nx">apiResponse</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="mocking-api-calls-for-testing">Mocking API Calls for Testing</h3> <p>Middleware can also be used to mock API calls during testing. This ensures that your tests are not dependent on external services, making them more reliable and faster.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">apiMockMiddleware</span><span class="p">(</span><span class="nx">request</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">test</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// In a testing environment, return a mocked response</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Response</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span> <span class="na">mockData</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}),</span> <span class="p">{</span>
      <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// In other environments, continue to the next Middleware or route handler</span>
    <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="waituntil-and-nextfetchevent"> <code class="language-plaintext highlighter-rouge">waitUntil</code> and <code class="language-plaintext highlighter-rouge">NextFetchEvent</code> </h3> <p>The <code class="language-plaintext highlighter-rouge">NextFetchEvent</code> object extends the native <code class="language-plaintext highlighter-rouge">FetchEvent</code> object, and includes the <code class="language-plaintext highlighter-rouge">waitUntil()</code> method. The <code class="language-plaintext highlighter-rouge">waitUntil()</code> method takes a promise as an argument, and extends the lifetime of the Middleware until the promise settles. This is useful for performing work in the background.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// middleware.ts</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">NextResponse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
<span class="k">import</span> <span class="kd">type</span> <span class="p">{</span> <span class="nx">NextFetchEvent</span><span class="p">,</span> <span class="nx">NextRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">next/server</span><span class="dl">'</span>
 
<span class="k">export</span> <span class="kd">function</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">NextRequest</span><span class="p">,</span> <span class="nx">event</span><span class="p">:</span> <span class="nx">NextFetchEvent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nf">waitUntil</span><span class="p">(</span>
    <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://my-analytics-platform.com</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">({</span> <span class="na">pathname</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span> <span class="p">}),</span>
    <span class="p">})</span>
  <span class="p">)</span>
 
  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div> <h2 id="faq">FAQ</h2> <h3 id="middleware-and-useformstate">middleware and useFormState?</h3> <p>When I add following code in middleware.ts, then <code class="language-plaintext highlighter-rouge">useFormState</code> won’t work propertly: the return <code class="language-plaintext highlighter-rouge">state</code> always be <code class="language-plaintext highlighter-rouge">undefined</code> which should be the returned value of the actionFn. Why?</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Add a new header x-current-path which passes the path to downstream components</span>
  <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Headers</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
  <span class="nx">headers</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">x-current-path</span><span class="dl">'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">nextUrl</span><span class="p">.</span><span class="nx">pathname</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">NextResponse</span><span class="p">.</span><span class="nf">next</span><span class="p">({</span> <span class="nx">headers</span> <span class="p">});</span>
</code></pre></div></div> </div> </article> </div> <div class="col-sm-3 post-side-container"> <div class="card hoverable post-side-sticky"> <div class="card-body post-side-detail"> <h5 class="card-title">Post Detail</h5> <div class="detail-item"> <div class="item-title">Published : </div> <div class="item-content">Oct 31, 2024</div> </div> <div class="detail-item"> <div class="item-title">Category : </div> <div class="item-content"> <a href="/blog/category/next-js"> <i class="fas fa-tag fa-sm"></i> Next.js</a> </div> </div> <div class="detail-item"> <div class="item-title">Tags : </div> </div> <div class="tags"> <a href="/blog/tag/react"> <div class="tag"> React </div> </a> <a href="/blog/tag/typescript"> <div class="tag"> TypeScript </div> </a> <a href="/blog/tag/next-js"> <div class="tag"> Next.js </div> </a> </div> <div class="detail-item"> <div class="item-title">Content : </div> </div> <div class="toc-container"> <div class="toc-item"> <a href="#overview"> # Overview </a> </div> <div class="toc-item"> <a href="#understand-middleware"> # Understand middleware </a> </div> <div class="toc-item"> <a href="#use-middleware-in-next-js"> # Use Middleware in Next.js </a> </div> <div class="toc-item"> <a href="#faq"> # FAQ </a> </div> </div> </div> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Ben Wen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/assets/js/jquery.min.js?d41d8cd98f00b204e9800998ecf8427e"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="/assets/js/tex-mml-chtml.js?d41d8cd98f00b204e9800998ecf8427e"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>